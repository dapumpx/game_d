!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.YIM=i()}(this,function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])};function e(t,i){function n(){this.constructor=t}r(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}var i=t;function t(){}t.mixin=function(t){var i=t.prototype||t;i.isWildEmitter=!0,i.on=function(t,i,n){this.callbacks=this.callbacks||{};var r=3===arguments.length,e=r?i:void 0,s=r?n:i;return s.t=e,(this.callbacks[t]=this.callbacks[t]||[]).push(s),this},i.once=function(i,t,n){var r=this,e=3===arguments.length,s=e?t:void 0,o=e?n:t;return this.on(i,s,function t(){r.off(i,t),o.apply(this,arguments)}),this},i.releaseGroup=function(t){var i,n,r,e;for(i in this.callbacks=this.callbacks||{},this.callbacks)for(n=0,r=(e=this.callbacks[i]).length;n<r;n++)e[n].t===t&&(e.splice(n,1),n--,r--);return this},i.off=function(t,i){this.callbacks=this.callbacks||{};var n,r=this.callbacks[t];return r&&(1===arguments.length?delete this.callbacks[t]:(n=r.indexOf(i),r.splice(n,1),0===r.length&&delete this.callbacks[t])),this},i.emit=function(t){this.callbacks=this.callbacks||{};var i,n,r,e=[].slice.call(arguments,1),s=this.callbacks[t],o=this.getWildcardCallbacks(t);if(s)for(i=0,n=(r=s.slice()).length;i<n&&r[i];++i)r[i].apply(this,e);if(o)for(n=o.length,i=0,n=(r=o.slice()).length;i<n&&r[i];++i)r[i].apply(this,[t].concat(e));return this},i.getWildcardCallbacks=function(t){this.callbacks=this.callbacks||{};var i,n,r=[];for(i in this.callbacks)n=i.split("*"),("*"===i||2===n.length&&t.slice(0,n[0].length)===n[0])&&(r=r.concat(this.callbacks[i]));return r}},t.mixin(t);var s=function(i){function t(){var t=i.call(this)||this;return t.i={appKey:"",userId:"",token:""},t}return e(t,i),t.prototype.set=function(t,i){this.i[t]=i,this.emit("change:"+t,t,i)},t.prototype.get=function(t){return this.i[t]},t}(i),o=function(r){function t(t,i){var n=r.call(this)||this;return n.n=t,n.r=i,n.e=!1,n.s=!1,n.o="",n.u="",n.h="",n.f=6,n.r.on("message:7",function(){n.r.close(),n.s=!1,n.emit("kickoff")}),n}return e(t,r),t.prototype.login=function(t,i,n){var r=this;return this.s?i!==this.u?(this.logout(),new Promise(function(t){setTimeout(function(){return t()},100)}).then(function(){return r.login(t,i,n)})):Promise.resolve():(this.e=!0,this.n.set("appKey",t),this.n.set("userId",i),this.n.set("token",n),this.o=t,this.u=i,this.h=n,this.emit("logging"),this.r.send(1,{appkey:t,userid:i+"",session:n+"",notify:1,base:{os_type:this.f,ip:"",port:0}}).then(function(){r.e=!1,r.s=!0,r.emit("login")}).catch(function(t){throw r.e=!1,r.s=!1,r.r.close(),r.emit("error:"+t.name,t),t}))},t.prototype.logout=function(){this.r.close(),this.s=!1,this.emit("logout")},t.prototype.isLogging=function(){return this.e},t.prototype.isLogged=function(){return this.s},t.prototype.doIfLogged=function(){var e=this;return new Promise(function(t,i){if(e.s)t();else{var n=setTimeout(function(){e.off("login",r);var t=new Error;t.name="NotLoginError",i(t)},1e4),r=function(){t(),clearTimeout(n)};e.once("login",r)}})},t.prototype.getMyUserId=function(){return this.u},t.prototype.reconnect=function(){return this.s=!1,this.login(this.o,this.u,this.h)},t}(i),u=function(r){function t(t,i){var n=r.call(this)||this;return n.n=t,n.r=i,n.c={},n.r.on("status:ended",function(){return n.clear()}),n}return e(t,r),t.prototype.joinRoom=function(i){var n=this;return i+="",this.c[i]||(this.c[i]=[this.n.get("userId")]),this.emit("joining:"+i,i),this.r.send(3,{roomid:i}).then(function(t){return n.emit("join:"+i,i),i}).catch(function(t){throw n.emit("join-error:"+t.name,t,i),delete n.c[i],t})},t.prototype.leaveRoom=function(i){var n=this;return i+="",this.r.send(4,{roomid:i}).then(function(){delete n.c[i],n.emit("leave:"+i,i)}).catch(function(t){throw n.emit("leave-error:"+t.name,t,i),t})},t.prototype.leaveAllRoom=function(){for(var t=[],i=0,n=Object.keys(this.c);i<n.length;i++){var r=n[i];t.push(this.leaveRoom(r))}return Promise.all(t).then(function(){})},t.prototype.clear=function(){for(var t=0,i=Object.keys(this.c);t<i.length;t++){var n=i[t];this.emit("leave:"+n,n)}this.c={}},t.prototype.doIfJoinedRoom=function(i){var n=this;return new Promise(function(t){i+="",n.inRoom(i)?t():n.once("join:"+i,function(){return t()})})},t.prototype.inRoom=function(t){return t+="",!!this.c[t]},t.prototype.getRoomIdList=function(){return Object.keys(this.c)},t.prototype.reconnect=function(){for(var i=this,t=function(t){n.r.send(4,{roomid:t}).then(function(){return i.r.send(3,{roomid:t})})},n=this,r=0,e=this.getRoomIdList();r<e.length;r++){t(e[r])}},t}(i),h="wss://webrtctest.youme.im",f=function(t){return t?"wss://"+t.substr(t.length-8).toLowerCase()+".h5.youme.im:443":""},c="disconnected",a="connected",v="reconnecting",l="ended",d={0:"OK",20001:"NotLoginError",20002:"InvalidParamError",20003:"InvalidLoginError",20004:"UsernameOrTokenError",20005:"LoginTimeoutError",20006:"ServiceOverloadError",20007:"MessageTooLongError"},w=function(n){function t(t){var i=n.call(this)||this;return i.n=t,i.a=1,i.f=6,i.v=null,i.l=h,i.d=c,i.w=[],i.g={},i.m={},i.y={},i.p=!1,i.b=[],i.A=[],i.j=1530625445318,i.T=0,i}return e(t,n),t.prototype.init=function(t){return t||(t=f(this.n.get("appKey"))),t&&(this.l=t,this.P(),this.k("connecting")),this},t.prototype.send=function(n,t){var r=this;if((this.d===c||this.d===l)&&(this.init(),this.d===c||this.d===l)){var i=new Error;return i.name="NotLoginError",Promise.reject(i)}return this.j++,t.base=t.base||{},t.base=Object.assign(t.base,{msgtype:n,seq:this.j+"",version:this.a,os_type:this.f}),this.w.push(t),this.I(),this.T&&clearTimeout(this.T),this.T=setTimeout(function(){return r.O()},6e4),new Promise(function(t,i){r.g[r.j]=t,r.m[r.j]=i,r.y[n]=r.j})},t.prototype.getStatus=function(){return this.d},t.prototype.close=function(){this.k(l),this.v&&(this.v.close(),this.v=null),this.w=[],this.g={},this.j=0,this.T&&(clearTimeout(this.T),this.T=0)},t.prototype.checkNetwork=function(){var n=this;return new Promise(function(t,i){n.b.push(t),n.A.push(i),n.p||n.O()})},t.prototype.P=function(){this.v&&this.v.close(),this.v=new WebSocket(this.l),this.B()},t.prototype.C=function(){var t=this;if(this.d!==l){if(this.d!==v){for(var i in this.m)this.m.hasOwnProperty(i)&&this.m[i](new DOMException("Socket was closed.","NetworkError"));this.g={},this.m={},this.k(v)}this.v=null,setTimeout(function(){t.d===v&&t.P()},1e3)}this.T&&(clearTimeout(this.T),this.T=0)},t.prototype.B=function(){var u=this;this.v&&(this.v.addEventListener("open",function(){u.k(a),u.emit("ready"),u.I()}),this.v.addEventListener("error",function(t){u.emit("error",t)}),this.v.addEventListener("close",function(){u.C()}),this.v.addEventListener("message",function(t){var i=JSON.parse(t.data),n=i.ret,r=i.base,e=r.msgtype,s=r.seq;if(s||(s=u.y[e]),s&&u.g[s]){if(n&&"0"!==n){var o=new Error;o.name=d[n]||"Error-"+n,u.m[s](o)}else u.g[s](i);delete u.g[s],delete u.m[s]}u.emit("message:"+e,i)}))},t.prototype.k=function(t){this.d!==t&&(this.d=t,this.emit("status:"+t,t))},t.prototype.I=function(){if(this.d===a&&this.v){for(var t=0,i=this.w;t<i.length;t++){var n=i[t];this.v.send(JSON.stringify(n));var r=n.base;this.emit("send:"+r.msgtype,n)}this.w=[]}},t.prototype.O=function(){var t=this;if(!this.p){this.p=!0;var i=setTimeout(function(){t.U(!1),t.v&&t.v.close(),t.C()},1e4);this.send(0,{}).then(function(){clearTimeout(i),t.U(!0)}).catch(function(){clearTimeout(i),t.U(!1)})}},t.prototype.U=function(t){if(t)for(var i=0,n=this.b;i<n.length;i++){var r=n[i];r&&r()}else for(var e=0,s=this.A;e<s.length;e++){var o=s[e];o&&o()}this.b=[],this.A=[],this.p=!1},t}(i),E="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var n,g=(function(p){!function(){var f="input is invalid type",t="object"==typeof window,i=t?window:{};i.JS_MD5_NO_WINDOW&&(t=!1);var n=!t&&"object"==typeof self,r=!i.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;r?i=E:n&&(i=self);var e,s=!i.JS_MD5_NO_COMMON_JS&&p.exports,c=!i.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,o="0123456789abcdef".split(""),u=[128,32768,8388608,-2147483648],a=[0,8,16,24],h=["hex","array","digest","buffer","arrayBuffer","base64"],v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),l=[];if(c){var d=new ArrayBuffer(68);e=new Uint8Array(d),l=new Uint32Array(d)}!i.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),!c||!i.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(t){return"object"==typeof t&&t.buffer&&t.buffer.constructor===ArrayBuffer});var w=function(i){return function(t){return new m(!0).update(t)[i]()}},g=function(i){var n=[eval][0]("require('crypto')"),r=[eval][0]("require('buffer').Buffer");return function(t){if("string"==typeof t)return n.createHash("md5").update(t,"utf8").digest("hex");if(null==t)throw f;return t.constructor===ArrayBuffer&&(t=new Uint8Array(t)),Array.isArray(t)||ArrayBuffer.isView(t)||t.constructor===r?n.createHash("md5").update(new r(t)).digest("hex"):i(t)}};function m(t){if(t)l[0]=l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0,this.blocks=l,this.buffer8=e;else if(c){var i=new ArrayBuffer(68);this.buffer8=new Uint8Array(i),this.blocks=new Uint32Array(i)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}m.prototype.update=function(t){if(!this.finalized){var i,n=typeof t;if("string"!==n){if("object"!==n)throw f;if(null===t)throw f;if(c&&t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!(Array.isArray(t)||c&&ArrayBuffer.isView(t)))throw f;i=!0}for(var r,e,s=0,o=t.length,u=this.blocks,h=this.buffer8;s<o;){if(this.hashed&&(this.hashed=!1,u[0]=u[16],u[16]=u[1]=u[2]=u[3]=u[4]=u[5]=u[6]=u[7]=u[8]=u[9]=u[10]=u[11]=u[12]=u[13]=u[14]=u[15]=0),i)if(c)for(e=this.start;s<o&&e<64;++s)h[e++]=t[s];else for(e=this.start;s<o&&e<64;++s)u[e>>2]|=t[s]<<a[3&e++];else if(c)for(e=this.start;s<o&&e<64;++s)(r=t.charCodeAt(s))<128?h[e++]=r:(r<2048?h[e++]=192|r>>6:(r<55296||57344<=r?h[e++]=224|r>>12:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++s)),h[e++]=240|r>>18,h[e++]=128|r>>12&63),h[e++]=128|r>>6&63),h[e++]=128|63&r);else for(e=this.start;s<o&&e<64;++s)(r=t.charCodeAt(s))<128?u[e>>2]|=r<<a[3&e++]:(r<2048?u[e>>2]|=(192|r>>6)<<a[3&e++]:(r<55296||57344<=r?u[e>>2]|=(224|r>>12)<<a[3&e++]:(r=65536+((1023&r)<<10|1023&t.charCodeAt(++s)),u[e>>2]|=(240|r>>18)<<a[3&e++],u[e>>2]|=(128|r>>12&63)<<a[3&e++]),u[e>>2]|=(128|r>>6&63)<<a[3&e++]),u[e>>2]|=(128|63&r)<<a[3&e++]);this.lastByteIndex=e,this.bytes+=e-this.start,64<=e?(this.start=e-64,this.hash(),this.hashed=!0):this.start=e}return 4294967295<this.bytes&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},m.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var t=this.blocks,i=this.lastByteIndex;t[i>>2]|=u[3&i],56<=i&&(this.hashed||this.hash(),t[0]=t[16],t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.bytes<<3,t[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},m.prototype.hash=function(){var t,i,n,r,e,s,o=this.blocks;this.first?i=((i=((t=((t=o[0]-680876937)<<7|t>>>25)-271733879<<0)^(n=((n=(-271733879^(r=((r=(-1732584194^2004318071&t)+o[1]-117830708)<<12|r>>>20)+t<<0)&(-271733879^t))+o[2]-1126478375)<<17|n>>>15)+r<<0)&(r^t))+o[3]-1316259209)<<22|i>>>10)+n<<0:(t=this.h0,i=this.h1,n=this.h2,i=((i+=((t=((t+=((r=this.h3)^i&(n^r))+o[0]-680876936)<<7|t>>>25)+i<<0)^(n=((n+=(i^(r=((r+=(n^t&(i^n))+o[1]-389564586)<<12|r>>>20)+t<<0)&(t^i))+o[2]+606105819)<<17|n>>>15)+r<<0)&(r^t))+o[3]-1044525330)<<22|i>>>10)+n<<0),i=((i+=((t=((t+=(r^i&(n^r))+o[4]-176418897)<<7|t>>>25)+i<<0)^(n=((n+=(i^(r=((r+=(n^t&(i^n))+o[5]+1200080426)<<12|r>>>20)+t<<0)&(t^i))+o[6]-1473231341)<<17|n>>>15)+r<<0)&(r^t))+o[7]-45705983)<<22|i>>>10)+n<<0,i=((i+=((t=((t+=(r^i&(n^r))+o[8]+1770035416)<<7|t>>>25)+i<<0)^(n=((n+=(i^(r=((r+=(n^t&(i^n))+o[9]-1958414417)<<12|r>>>20)+t<<0)&(t^i))+o[10]-42063)<<17|n>>>15)+r<<0)&(r^t))+o[11]-1990404162)<<22|i>>>10)+n<<0,i=((i+=((t=((t+=(r^i&(n^r))+o[12]+1804603682)<<7|t>>>25)+i<<0)^(n=((n+=(i^(r=((r+=(n^t&(i^n))+o[13]-40341101)<<12|r>>>20)+t<<0)&(t^i))+o[14]-1502002290)<<17|n>>>15)+r<<0)&(r^t))+o[15]+1236535329)<<22|i>>>10)+n<<0,i=((i+=((r=((r+=(i^n&((t=((t+=(n^r&(i^n))+o[1]-165796510)<<5|t>>>27)+i<<0)^i))+o[6]-1069501632)<<9|r>>>23)+t<<0)^t&((n=((n+=(t^i&(r^t))+o[11]+643717713)<<14|n>>>18)+r<<0)^r))+o[0]-373897302)<<20|i>>>12)+n<<0,i=((i+=((r=((r+=(i^n&((t=((t+=(n^r&(i^n))+o[5]-701558691)<<5|t>>>27)+i<<0)^i))+o[10]+38016083)<<9|r>>>23)+t<<0)^t&((n=((n+=(t^i&(r^t))+o[15]-660478335)<<14|n>>>18)+r<<0)^r))+o[4]-405537848)<<20|i>>>12)+n<<0,i=((i+=((r=((r+=(i^n&((t=((t+=(n^r&(i^n))+o[9]+568446438)<<5|t>>>27)+i<<0)^i))+o[14]-1019803690)<<9|r>>>23)+t<<0)^t&((n=((n+=(t^i&(r^t))+o[3]-187363961)<<14|n>>>18)+r<<0)^r))+o[8]+1163531501)<<20|i>>>12)+n<<0,i=((i+=((r=((r+=(i^n&((t=((t+=(n^r&(i^n))+o[13]-1444681467)<<5|t>>>27)+i<<0)^i))+o[2]-51403784)<<9|r>>>23)+t<<0)^t&((n=((n+=(t^i&(r^t))+o[7]+1735328473)<<14|n>>>18)+r<<0)^r))+o[12]-1926607734)<<20|i>>>12)+n<<0,i=((i+=((s=(r=((r+=((e=i^n)^(t=((t+=(e^r)+o[5]-378558)<<4|t>>>28)+i<<0))+o[8]-2022574463)<<11|r>>>21)+t<<0)^t)^(n=((n+=(s^i)+o[11]+1839030562)<<16|n>>>16)+r<<0))+o[14]-35309556)<<23|i>>>9)+n<<0,i=((i+=((s=(r=((r+=((e=i^n)^(t=((t+=(e^r)+o[1]-1530992060)<<4|t>>>28)+i<<0))+o[4]+1272893353)<<11|r>>>21)+t<<0)^t)^(n=((n+=(s^i)+o[7]-155497632)<<16|n>>>16)+r<<0))+o[10]-1094730640)<<23|i>>>9)+n<<0,i=((i+=((s=(r=((r+=((e=i^n)^(t=((t+=(e^r)+o[13]+681279174)<<4|t>>>28)+i<<0))+o[0]-358537222)<<11|r>>>21)+t<<0)^t)^(n=((n+=(s^i)+o[3]-722521979)<<16|n>>>16)+r<<0))+o[6]+76029189)<<23|i>>>9)+n<<0,i=((i+=((s=(r=((r+=((e=i^n)^(t=((t+=(e^r)+o[9]-640364487)<<4|t>>>28)+i<<0))+o[12]-421815835)<<11|r>>>21)+t<<0)^t)^(n=((n+=(s^i)+o[15]+530742520)<<16|n>>>16)+r<<0))+o[2]-995338651)<<23|i>>>9)+n<<0,i=((i+=((r=((r+=(i^((t=((t+=(n^(i|~r))+o[0]-198630844)<<6|t>>>26)+i<<0)|~n))+o[7]+1126891415)<<10|r>>>22)+t<<0)^((n=((n+=(t^(r|~i))+o[14]-1416354905)<<15|n>>>17)+r<<0)|~t))+o[5]-57434055)<<21|i>>>11)+n<<0,i=((i+=((r=((r+=(i^((t=((t+=(n^(i|~r))+o[12]+1700485571)<<6|t>>>26)+i<<0)|~n))+o[3]-1894986606)<<10|r>>>22)+t<<0)^((n=((n+=(t^(r|~i))+o[10]-1051523)<<15|n>>>17)+r<<0)|~t))+o[1]-2054922799)<<21|i>>>11)+n<<0,i=((i+=((r=((r+=(i^((t=((t+=(n^(i|~r))+o[8]+1873313359)<<6|t>>>26)+i<<0)|~n))+o[15]-30611744)<<10|r>>>22)+t<<0)^((n=((n+=(t^(r|~i))+o[6]-1560198380)<<15|n>>>17)+r<<0)|~t))+o[13]+1309151649)<<21|i>>>11)+n<<0,i=((i+=((r=((r+=(i^((t=((t+=(n^(i|~r))+o[4]-145523070)<<6|t>>>26)+i<<0)|~n))+o[11]-1120210379)<<10|r>>>22)+t<<0)^((n=((n+=(t^(r|~i))+o[2]+718787259)<<15|n>>>17)+r<<0)|~t))+o[9]-343485551)<<21|i>>>11)+n<<0,this.first?(this.h0=t+1732584193<<0,this.h1=i-271733879<<0,this.h2=n-1732584194<<0,this.h3=r+271733878<<0,this.first=!1):(this.h0=this.h0+t<<0,this.h1=this.h1+i<<0,this.h2=this.h2+n<<0,this.h3=this.h3+r<<0)},m.prototype.toString=m.prototype.hex=function(){this.finalize();var t=this.h0,i=this.h1,n=this.h2,r=this.h3;return o[t>>4&15]+o[15&t]+o[t>>12&15]+o[t>>8&15]+o[t>>20&15]+o[t>>16&15]+o[t>>28&15]+o[t>>24&15]+o[i>>4&15]+o[15&i]+o[i>>12&15]+o[i>>8&15]+o[i>>20&15]+o[i>>16&15]+o[i>>28&15]+o[i>>24&15]+o[n>>4&15]+o[15&n]+o[n>>12&15]+o[n>>8&15]+o[n>>20&15]+o[n>>16&15]+o[n>>28&15]+o[n>>24&15]+o[r>>4&15]+o[15&r]+o[r>>12&15]+o[r>>8&15]+o[r>>20&15]+o[r>>16&15]+o[r>>28&15]+o[r>>24&15]},m.prototype.array=m.prototype.digest=function(){this.finalize();var t=this.h0,i=this.h1,n=this.h2,r=this.h3;return[255&t,t>>8&255,t>>16&255,t>>24&255,255&i,i>>8&255,i>>16&255,i>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,255&r,r>>8&255,r>>16&255,r>>24&255]},m.prototype.buffer=m.prototype.arrayBuffer=function(){this.finalize();var t=new ArrayBuffer(16),i=new Uint32Array(t);return i[0]=this.h0,i[1]=this.h1,i[2]=this.h2,i[3]=this.h3,t},m.prototype.base64=function(){for(var t,i,n,r="",e=this.array(),s=0;s<15;)t=e[s++],i=e[s++],n=e[s++],r+=v[t>>>2]+v[63&(t<<4|i>>>4)]+v[63&(i<<2|n>>>6)]+v[63&n];return t=e[s],r+=v[t>>>2]+v[t<<4&63]+"=="};var y=function(){var i=w("hex");r&&(i=g(i)),i.create=function(){return new m},i.update=function(t){return i.create().update(t)};for(var t=0;t<h.length;++t){var n=h[t];i[n]=w(n)}return i}();s?p.exports=y:i.md5=y}()}(n={exports:{}},n.exports),n.exports),m=(g.hex,g.array,g.digest,g.arrayBuffer,g.buffer,g.create),y=(g.update,g.base64,function(t){function c(){var i=null!==t&&t.apply(this,arguments)||this;return i.__isReady=!1,i.__isCanceled=!1,i.__reqUpTk=null,i.__reqWXTk=null,i.__onReadyQueue=[],i.__onCancelQueue=[],i.__onSetUpTkFn=[],i.__onSetWXTkFn=[],i.__content="",i.typeId=0,i.__controls={initWithContent:function(t){return i.initWithContent(t).then(function(){return i.setContent(t)})},getContent:function(){return i.getContent()},getTypeId:function(){return i.getTypeId()},getType:function(){return i.getType()},onRequestUploadToken:function(t){return i.__onReqUpTk(t)},onRequestWechatToken:function(t){return i.__onReqWXTk(t)},waitForContent:function(){return i.__waitForContent()}},i}return e(c,t),c.prototype.setContent=function(t){this.__content="string"==typeof t?t:JSON.stringify(t),this.__isReady=!0;for(var i=0,n=this.__onReadyQueue;i<n.length;i++){(0,n[i])(this.__content)}this.__onReadyQueue=[]},c.prototype.setCanceled=function(){this.__isCanceled=!0;for(var t=0,i=this.__onCancelQueue;t<i.length;t++){var n=i[t],r=new Error("Message Canceled.");r.name="CanceledError",n(r)}this.__onCancelQueue=[]},c.prototype.uploadFile=function(h){var f=this;return new Promise(function(s,o){var e,u=new FileReader;u.onload=function(){if(!(e=u.result)){var t=new Error;return t.name="UploadFileError",o(t)}var i=m();i.update(e);var n=i.hex(),r=function(n){var r=new XMLHttpRequest;r.ontimeout=function(t){o(t)},r.onerror=function(t){o(t)},r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var t=n.downloadUrl,i=t.indexOf(":");-1<i&&i<7&&(t=t.substr(i+1)),s(t)}};var t=n.uploadUrl,i=t.indexOf(":");for(var e in-1<i&&i<7&&(t=t.substr(i+1)),r.open("PUT",t,!0),r.timeout=6e4,n.headers)"host"!==e&&n.headers.hasOwnProperty(e)&&r.setRequestHeader(e,n.headers[e]);r.send(h)};if(f.__reqUpTk)f.__reqUpTk(h.size,n,n,h.type.split("/")[1]).then(r).catch(function(t){return o(t)});else if(c.__gControls.reqUpTk)c.__gControls.reqUpTk(h.size,n,n,h.type.split("/")[1]).then(r).catch(function(t){return o(t)});else{new Promise(function(t){f.__onSetUpTkFn.push(t)}).then(function(){f.__reqUpTk(h.size,n,n,h.type.split("/")[1]).then(r).catch(function(t){return o(t)})})}},u.readAsArrayBuffer(h)})},c.prototype.requestWechatToken=function(){var i=this;return this.__reqWXTk?this.__reqWXTk():c.__gControls.reqWXTk?c.__gControls.reqWXTk():new Promise(function(t){i.__onSetWXTkFn.push(t)}).then(function(){return i.__reqWXTk()})},c.prototype.isReady=function(){return this.__isReady},c.prototype.isCanceled=function(){return this.__isCanceled},c.prototype.onReady=function(t,i){if(this.__isReady)return t();this.__isCanceled?i&&i():this.__waitForContent().then(function(){t()}).catch(function(t){"CanceledError"===t.name&&i&&i()})},c.prototype.getContent=function(){var t;if(this.__isCanceled)throw(t=new Error("Message Canceled.")).name="CanceledError",t;if(!this.__isReady)throw(t=new Error("Content is not ready yet.")).name="ContentNotReadyError",t;return this.__content},c.prototype.getTypeId=function(){return this.typeId},c.prototype.getType=function(){return this.typeName},c.prototype.__onReqUpTk=function(t){this.__reqUpTk=t;for(var i=0,n=this.__onSetUpTkFn;i<n.length;i++){(0,n[i])()}this.__onSetUpTkFn=[]},c.prototype.__onReqWXTk=function(t){this.__reqWXTk=t;for(var i=0,n=this.__onSetWXTkFn;i<n.length;i++){(0,n[i])()}this.__onSetWXTkFn=[]},c.prototype.__waitForContent=function(){var n=this;if(this.__isReady)return Promise.resolve(this.__content);if(this.__isCanceled){var t=new Error("Message Canceled.");return t.name="CanceledError",Promise.reject(t)}return new Promise(function(t,i){n.__onReadyQueue.push(t),n.__onCancelQueue.push(i)})},c.__gControls={},c}(i)),p=function(r){function s(t,i){var n=r.call(this)||this;return n.n=t,n.r=i,n.x={},n.M={},n.N=new Set,n._={},n.L={},n.S="",n.q=new Date(0),n.r.on("message:9",function(t){t&&"object"==typeof t.args&&n.r.send(10,{msgid:"0"}).then(function(t){n.D(t)})}),y.__gControls.reqUpTk=n.F.bind(n),y.__gControls.reqWXTk=n.R.bind(n),n}return e(s,r),s.prototype.registerMessageType=function(t){var i=new t,n=i.__controls.getTypeId(),r=i.__controls.getType();0===n&&"text"!==r?this.L[r]=t:this._[n]=t},s.prototype.sendToRoom=function(n,r){var e=this;return n+="",this.K(r).then(function(i){var t=s.J(n,"group",i);return e.W(t).then(function(t){var i=e.z(n,"group",t.svr_msgid,r);return e.H(i),e.emit("send:group:"+n,i),i}).catch(function(t){throw e.emit("send-failed:"+t.name+":group:"+n+":"+t.name,i,t),t})})},s.prototype.sendToUser=function(n,r){var e=this;return this.K(r).then(function(i){var t=s.J(n,"user",i);return e.W(t).then(function(t){var i=e.z(n,"user",t.svr_msgid,r);return e.H(i),e.emit("send:user:"+n,i),i}).catch(function(t){throw e.emit("send-failed:"+t.name+":user:"+n,i,t),t})})},s.prototype.requestHistoryMessage=function(t,i,n,r){var o=this;return this.r.send(11,{interlocutor:t,min_msgid:i,max_msgid:n,day_interval:r}).then(function(t){for(var i=[],n=0,r=t.msg_list;n<r.length;n++){var e=r[n],s=o.X(e);i.push(s)}return i})},s.prototype.clear=function(){this.x={},this.M={},this.N.clear()},s.prototype.D=function(t){for(var e=this,i=t.msg_list,n=function(t){var i=s.X(t),n=i.withPeer,r=i.chatType;s.H(i)&&s.K(i.message).then(function(){e.emit("receive:"+r+":"+n,i)})},s=this,r=0,o=i;r<o.length;r++){n(o[r])}},s.prototype.X=function(t){var i,n=this,r=t.sender,e=t.receiver,s=t.sender===this.n.get("userId");switch(t.chattype){case 1:default:i="user";break;case 2:i="group"}var o,u=new Date(1e3*t.timespan),h=t.msgtype,f=t.content;if(0===h){var c=f.match(/^(.+?)!/),a=c?c[1]:null;a?(f=f.replace(/^(.+?)!/,""),o=this.L[a]):o=this._[0]}else o=this._[h];if(!o){var v=new Error;throw v.name="MessageTypeMissingError",v}var l=new o;return l.__controls.initWithContent(f).catch(function(t){n.emit("error:"+t.name,t)}),{senderId:r,receiverId:e,withPeer:s||"group"===i?e:r,isFromMe:s,chatType:i,time:u,serial:t.serial,serverId:t.svr_msgid,message:l}},s.J=function(t,i,n){var r,e;switch(i){case"user":default:r=1;break;case"group":r=2}return e=0===n.getTypeId()&&"text"!==n.getType()?n.getType()+"!"+n.getContent():n.getContent(),{msgbodytype:n.getTypeId(),chattype:r,receiver:t,content:e}},s.prototype.z=function(t,i,n,r){return{senderId:this.n.get("userId"),receiverId:t,withPeer:t,isFromMe:!0,chatType:i,time:new Date,serverId:n,message:r}},s.prototype.H=function(t){if(this.N.has(t.serverId))return!1;var i=t.withPeer;switch(t.chatType){case"group":for(this.M[i]=this.M[i]||[],this.M[i].push(t),this.N.add(t.serverId);30<this.M[i].length;){(n=this.M[i].shift())&&this.N.delete(n.serverId)}break;case"user":for(this.x[i]=this.x[i]||[],this.x[i].push(t),this.N.add(t.serverId);30<this.x[i].length;){var n;(n=this.x[i].shift())&&this.N.delete(n.serverId)}}return!0},s.prototype.W=function(t){return this.r.send(5,t)},s.prototype.K=function(t){var e=this;return t.__controls.onRequestUploadToken(function(t,i,n,r){return e.F(t,i,n,r)}),t.__controls.onRequestWechatToken(function(){return e.R()}),t.__controls.waitForContent().then(function(){return t}).catch(function(t){throw"CanceledError"===t.name&&e.emit("error:"+t.name,t),t})},s.prototype.F=function(t,i,n,r){return this.r.send(8,{filename:n,filesize:t,filemd5:i,filesuffix:r}).then(function(t){return{headers:t.headers,uploadUrl:t.token,downloadUrl:t.downloadurl}})},s.prototype.R=function(){var i=this,t=+new Date-+this.q;return this.S&&t<3e5?Promise.resolve(this.S):this.r.send(12,{}).then(function(t){return i.S=t.token,i.q=new Date,i.S})},s}(i);return function(n){function t(t){var i=n.call(this)||this;return i.o="",i.n=new s,i.r=new w(i.n),i.G=new o(i.n,i.r),i.Q=new u(i.n,i.r),i.V=new p(i.n,i.r),i.Y(),i.Z(),i.$(),i.tt(),i.it(),t&&i.init(t).then(),i}return e(t,n),t.prototype.init=function(t){var i=[];if(this.o=t.appKey,t.userId&&t.token&&i.push(this.login(t.userId,t.token,!0).then(function(){})),t.roomId){t.roomId instanceof Array||(t.roomId=[t.roomId]);for(var n=0,r=t.roomId;n<r.length;n++){var e=r[n];i.push(this.joinRoom(e).then(function(){}))}}return t.useMessageType&&this.registerMessageType(t.useMessageType),t.userId&&t.token?Promise.all(i).then(function(){}):Promise.resolve()},t.prototype.uninit=function(){this.logout()},t.prototype.login=function(t,i,n){return void 0===n&&(n=!1),this.G.login(this.o,t,i).catch(function(t){if(!n)throw t})},t.prototype.logout=function(){this.Q.clear(),this.V.clear(),this.G.logout()},t.prototype.isLogging=function(){return this.G.isLogging()},t.prototype.isLogged=function(){return this.G.isLogged()},t.prototype.getMyUserId=function(){return this.G.getMyUserId()},t.prototype.joinRoom=function(t){var i=this;return this.G.doIfLogged().then(function(){return i.Q.joinRoom(t)})},t.prototype.leaveRoom=function(t){var i=this;return this.G.doIfLogged().then(function(){return t?i.Q.leaveRoom(t):i.Q.leaveAllRoom()})},t.prototype.inRoom=function(t){return this.Q.inRoom(t)},t.prototype.getRoomIdList=function(){return this.Q.getRoomIdList()},t.prototype.registerMessageType=function(t){if(t instanceof Array)for(var i=0,n=t;i<n.length;i++){var r=n[i];this.V.registerMessageType(r)}else this.V.registerMessageType(t)},t.prototype.sendToRoom=function(t,i,n){var r=this;return void 0===n&&(n=!1),this.G.doIfLogged().then(function(){return r.Q.doIfJoinedRoom(t)}).then(function(){return r.V.sendToRoom(t,i)}).catch(function(t){if(!n&&(n=!0,!i.isCanceled()))throw t})},t.prototype.sendToUser=function(t,i,n){var r=this;return void 0===n&&(n=!1),this.G.doIfLogged().then(function(){return r.V.sendToUser(t,i)}).catch(function(t){if(!n&&(n=!0,!i.isCanceled()))throw t})},t.prototype.requestHistoryMessage=function(t,i,n,r){return this.V.requestHistoryMessage(t,i,n,r)},t.prototype.Y=function(){var t=this;this.r.on("status:reconnecting",function(){return t.G.reconnect().then(function(){return t.Q.reconnect()})})},t.prototype.Z=function(){var n=this;this.G.on("login",function(){return n.emit("account.login")}),this.G.on("logging",function(){return n.emit("account.logging")}),this.G.on("logout",function(){return n.emit("account.logout")}),this.G.on("kickoff",function(){return n.emit("account.kickoff")}),this.G.on("error:*",function(t,i){return n.emit("account."+t,i)})},t.prototype.$=function(){var r=this;this.Q.on("join:*",function(t,i){return r.emit("room.join:"+i,i)}),this.Q.on("joining:*",function(t,i){return r.emit("room.joining:"+i,i)}),this.Q.on("leave:*",function(t,i){return r.emit("room.leave:"+i,i)}),this.Q.on("join-error:*",function(t,i,n){return r.emit("room.join-error:"+i.name,i,n)}),this.Q.on("leave-error:*",function(t,i,n){return r.emit("room.leave-error:"+i.name,i,n)})},t.prototype.tt=function(){var r=this;this.V.on("send:*",function(t,i){return r.emit("message:send:"+i.chatType+":"+i.withPeer,i)}),this.V.on("send-failed:*",function(t,i,n){return r.emit("message:"+t,i,n)}),this.V.on("receive:*",function(t,i){return r.emit("message:receive:"+i.chatType+":"+i.withPeer,i)})},t.prototype.it=function(){var n=this;this.r.on("status:*",function(t,i){return n.emit("signaling.status:"+i,i)}),this.r.on("ready",function(){return n.emit("signaling.ready")}),this.r.on("message:*",function(t,i){return n.emit("signaling.receive:"+i.base.msgtype,i)}),this.r.on("send:*",function(t,i){return n.emit("signaling.send:"+i.base.msgtype,i)}),this.r.on("error",function(t){return n.emit("signaling.error",t)})},t.Message=y,t.WildEmitter=i,t}(i)});
