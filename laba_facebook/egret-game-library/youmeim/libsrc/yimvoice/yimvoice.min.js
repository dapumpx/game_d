!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i(require("youme-im/core")):"function"==typeof define&&define.amd?define(["youme-im/core"],i):t.VoiceMessage=i(t.YIM)}(this,function(t){t=t&&t.hasOwnProperty("default")?t.default:t;var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var r in i)i.hasOwnProperty(r)&&(t[r]=i[r])};var r=function(){function t(){var n=this;this.__uploadFn=null,this.__onSetUploadFn=[],this.__getWXTkFn=null,this.__onSetWXTkFn=[],this.__controls={setUploadFunc:function(t){n.__uploadFn=t;for(var i=0,r=n.__onSetUploadFn;i<r.length;i++){(0,r[i])()}n.__onSetUploadFn=[]},setWechatTokenFunc:function(t){n.__getWXTkFn=t;for(var i=0,r=n.__onSetWXTkFn;i<r.length;i++){(0,r[i])()}n.__onSetWXTkFn=[]}}}return t.prototype.getTypeId=function(){return this.typeId},t.prototype.getType=function(){return this.typeName},t.prototype.uploadFile=function(t){var i=this;return this.__uploadFn?this.__uploadFn(t):new Promise(function(t){i.__onSetUploadFn.push(t)}).then(function(){return i.__uploadFn(t)})},t.prototype.requestWechatToken=function(){var i=this;return this.__getWXTkFn?this.__getWXTkFn():new Promise(function(t){i.__onSetWXTkFn.push(t)}).then(function(){return i.__getWXTkFn()})},t}();return function(i){function o(){var t=null!==i&&i.apply(this,arguments)||this;return t.typeId=1,t.typeName="voice",t.t=null,t.i=null,t.r=!1,t.n=0,t}return function(t,i){function r(){this.constructor=t}n(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}(o,i),o.registerRecorder=function(t){for(var i=0,r=t;i<r.length;i++){var n=r[i],s=new n;s.isEnvSupport()&&(this.s.push(n),this.o.push(s))}},o.isEnvSupport=function(){return!!this.s.length},o.initRecorder=function(){return(new o).initRecord()},o.h=function(){var t=this;if(this.e[0]){var i=this.e[0];this.u.emit("begin-play",i),i.play(),i.on("end-play",function(){t.u.emit("end-play",i),t.e.shift(),t.e[0]&&t.u.emit("next",t.e[0]),t.h()})}else this.u.emit("all-ended")},o.addToAutoPlayQueue=function(t){this.e.push(t),this.u.emit("add",t),1===this.e.length&&this.h()},o.getAutoPlayQueueLength=function(){return this.e.length},o.getCurrentAutoPlayingMessage=function(){return this.e[0]},o.nextAutoPlay=function(){this.e.length&&(this.e[0].stop(),this.e.shift(),this.e[0]&&this.u.emit("next",this.e[0]),this.h())},o.stopAndClearAutoPlayQueue=function(){this.e.length&&(this.e[0].stop(),this.e=[],this.h())},o.bindAutoPlayEvent=function(t,i){this.u.on(""+t,i)},o.unbindAutoPlayEvent=function(t,i){this.u.off(""+t,i)},o.prototype.initWithContent=function(i){var r,t=this;try{r=JSON.parse(i)}catch(t){r=i}for(var n=0,s=o.s.length;n<s;n++)if(o.o[n].isSupportMsg(r))return this.t=new o.s[n],this.t.__controls.setUploadFunc(this.uploadFile.bind(this)),this.t.__controls.setWechatTokenFunc(this.requestWechatToken.bind(this)),this.t.initWithJsonMsg(r).then(function(){t.t.onPlayEnd(function(){t.emit("end-play")}),t.setContent(i)});return this.i=new Error("Unsupported voice message format."),this.i.name="UnsupportedVoiceFormatError",Promise.reject(this.i)},o.prototype.initRecord=function(){return o.isEnvSupport()?this.isReady()?(this.i=new Error,this.i.name="AlreadyReadyError"):this.isCanceled()&&(this.i=new Error,this.i.name="CanceledError"):(this.i=new Error,this.i.name="DeviceNotSupportedError"),this.i?(this.emit("error:"+this.i.name,this.i),Promise.reject(this.i)):this.t?Promise.resolve():(this.t=new o.s[0],this.t.__controls.setUploadFunc(this.uploadFile.bind(this)),this.t.__controls.setWechatTokenFunc(this.requestWechatToken.bind(this)),this.t.initRecord().catch(function(t){throw"NotSupportedError"===t.name&&(t.name="DeviceNotSupportedError"),t}))},o.prototype.startRecord=function(i){var r=this;return void 0===i&&(i=!1),this.r=!0,this.isCanceled()?(this.i=new Error,this.i.name="CanceledError",i?Promise.resolve():Promise.reject(this.i)):(this.i=null,this.initRecord().then(function(){if(!r.isCanceled())return r.t.onPlayEnd(function(){r.emit("end-play")}),r.t.onRecordEnd(function(){r.setContent(r.t.getJsonMsg()),r.emit("finish-record")}),r.t.startRecord()}).then(function(){if(r.isError()){if(r.t&&r.t.cancelRecord(),i)return;throw r.i}r.n=setTimeout(function(){r.r=!1},1e3),r.emit("start-record")}).catch(function(t){if(r.i=t,r.emit("error:"+t.name,t),r.cancelRecord(),!i)throw r.i}))},o.prototype.finishRecord=function(i){var r=this;return void 0===i&&(i=!1),this.i||(this.t?this.isCanceled()&&(this.i=new Error,this.i.name="CanceledError"):(this.i=new Error,this.i.name="RecorderNotStartedError")),this.i?(this.emit("error:"+this.i.name),i?Promise.resolve():Promise.reject(this.i)):this.r?(this.t&&this.t.cancelRecord(),this.setCanceled(),this.i=new Error,this.i.name="RecordTooShortError",this.emit("error:"+this.i.name),clearTimeout(this.n),i?Promise.resolve():Promise.reject(this.i)):(this.emit("finishing-record"),this.t.finishRecord().catch(function(t){if(r.setCanceled(),(r.i=t)&&t.name&&r.emit("error:"+t.name),!i)throw t}))},o.prototype.cancelRecord=function(){this.t&&this.t.cancelRecord(),this.setCanceled(),this.emit("cancel-record")},o.prototype.isRecording=function(){return!!this.t&&this.t.isRecording()},o.prototype.isError=function(){return!!this.i},o.prototype.getErrorName=function(){return this.i?this.i.name:""},o.prototype.play=function(){var t=this;this.onReady(function(){t.t.play(),t.emit("play")})},o.prototype.stop=function(){this.isReady()&&this.t&&this.t.isPlaying()&&(this.t.stop(),this.emit("stop"))},o.prototype.isPlaying=function(){return!!this.t&&this.t.isPlaying()},o.prototype.getDuration=function(){return this.t?this.t.getDuration():0},o.s=[],o.o=[],o.Recorder=r,o.e=[],o.u=new t.WildEmitter,o}(t.Message)});
