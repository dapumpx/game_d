!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.YMRTC=t()}(this,function(){function e(e,t){function n(){this.constructor=e}p(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function t(e,t,n){var r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}function n(e,t,n){var r=n?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;var o=[];return e.forEach(function(e){"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)}),o.forEach(function(t){e.forEach(function(n){n.type===r&&n.trackId===t.id&&function o(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach(function(r){r.endsWith("Id")?o(e,e.get(t[r]),n):r.endsWith("Ids")&&t[r].forEach(function(t){o(e,e.get(t),n)})}))}(e,n,i)})}),i}function r(e,t,n,r,i){var o=b.writeRtpDescription(e.kind,t);if(o+=b.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=b.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":i||"active"),o+="a=mid:"+e.mid+"\r\n",o+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var a=e.rtpSender.f||e.rtpSender.track.id;e.rtpSender.f=a;var s="msid:"+(r?r.id:"-")+" "+a+"\r\n";o+="a="+s,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+b.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+b.localCName+"\r\n"),o}function i(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]};return e.codecs.forEach(function(i){for(var o=0;o<t.codecs.length;o++){var a=t.codecs[o];if(i.name.toLowerCase()===a.name.toLowerCase()&&i.clockRate===a.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&a.parameters.apt&&(s=i,c=a,d=e.codecs,u=t.codecs,l=p=void 0,p=r(s.parameters.apt,d),l=r(c.parameters.apt,u),!p||!l||p.name.toLowerCase()!==l.name.toLowerCase()))continue;(a=JSON.parse(JSON.stringify(a))).numChannels=Math.min(i.numChannels,a.numChannels),n.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter(function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}var s,c,d,u,p,l}),e.headerExtensions.forEach(function(e){for(var r=0;r<t.headerExtensions.length;r++){var i=t.headerExtensions[r];if(e.uri===i.uri){n.headerExtensions.push(i);break}}}),n}function o(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function a(e,t){var n=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return n||e.addRemoteCandidate(t),!n}function s(e,t){var n=new Error(t);return n.name=e,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],n}function c(){}function d(e){function t(){if(null!=J)if(d.debug("Long poll..."),G){var r=D+"/"+J+"?rid="+(new Date).getTime();null!=N&&(r=r+"&maxev="+N),null!=V&&(r=r+"&token="+encodeURIComponent(V)),null!=U&&(r=r+"&apisecret="+encodeURIComponent(U)),d.httpAPICall(r,{verb:"GET",withCredentials:L,success:n,timeout:B,error:function(n,r){return d.error(n+":",r),3<++q?(G=!1,void e.error("Lost connection to the server (is it down?)")):void t()}})}else d.warn("Is the server down? (connected=false)")}function n(e,r){if(q=0,k||null==J||!0===r||setTimeout(t,200),k||!d.isArray(e))if("keepalive"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(null==(c=e.sender))return void d.warn("Missing sender...");if(null==(p=H[c]))return void d.debug("This handle is not attached to this session");var i=e.candidate;d.debug("Got a trickled candidate on session "+J),d.debug(i);var o=p.webrtcStuff;o.pc&&o.remoteSdp?(d.debug("Adding remote candidate:",i),i&&!0!==i.completed?o.pc.addIceCandidate(i):o.pc.addIceCandidate()):(d.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),o.candidates||(o.candidates=[]),o.candidates.push(i),d.debug(o.candidates))}else{if("webrtcup"===e.janus)return d.debug("Got a webrtcup event on session "+J),d.debug(e),null==(c=e.sender)?void d.warn("Missing sender..."):null==(p=H[c])?void d.debug("This handle is not attached to this session"):void p.webrtcState(!0);if("hangup"===e.janus){if(d.debug("Got a hangup event on session "+J),d.debug(e),null==(c=e.sender))return void d.warn("Missing sender...");if(null==(p=H[c]))return void d.debug("This handle is not attached to this session");p.webrtcState(!1,e.reason),p.hangup()}else if("detached"===e.janus){if(d.debug("Got a detached event on session "+J),d.debug(e),null==(c=e.sender))return void d.warn("Missing sender...");if(null==(p=H[c]))return;p.detached=!0,p.ondetached(),p.detach()}else if("media"===e.janus){if(d.debug("Got a media event on session "+J),d.debug(e),null==(c=e.sender))return void d.warn("Missing sender...");if(null==(p=H[c]))return void d.debug("This handle is not attached to this session");p.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(d.debug("Got a slowlink event on session "+J),d.debug(e),null==(c=e.sender))return void d.warn("Missing sender...");if(null==(p=H[c]))return void d.debug("This handle is not attached to this session");p.slowLink(e.uplink,e.nacks)}else{if("error"===e.janus){var a,s;return d.error("Ooops: "+e.error.code+" "+e.error.reason),d.debug(e),null!=(a=e.transaction)&&(null!=(s=_[a])&&s(e),delete _[a]),void 0}if("event"===e.janus){var c;if(d.debug("Got a plugin event on session "+J),d.debug(e),null==(c=e.sender))return void d.warn("Missing sender...");var u=e.plugindata;if(null==u)return void d.warn("Missing plugindata...");d.debug("  -- Event is coming from "+c+" ("+u.plugin+")");var p,l=u.data;if(d.debug(l),null==(p=H[c]))return void d.warn("This handle is not attached to this session");var f=e.jsep;null!=f&&(d.debug("Handling SDP as well..."),d.debug(f));var v=p.onmessage;null!=v?(d.debug("Notifying application..."),v(l,f)):d.debug("No provided notification callback")}else d.warn("Unknown message/event  '"+e.janus+"' on session "+J),d.debug(e)}}else d.debug("Got a success on session "+J),d.debug(e),null!=(a=e.transaction)&&(null!=(s=_[a])&&s(e),delete _[a]);else d.debug("Got an ack on session "+J),d.debug(e),null!=(a=e.transaction)&&(null!=(s=_[a])&&s(e),delete _[a]);else d.vdebug("Got a keepalive on session "+J);else for(var m=0;m<e.length;m++)n(e[m],!0)}function r(){if(null!==D&&k&&G){E=setTimeout(r,F);var e={janus:"keepalive",session_id:J,transaction:d.randomString(12)};null!=V&&(e.token=V),null!=U&&(e.apisecret=U),R.send(JSON.stringify(e))}}function i(o){var a=d.randomString(12),s={janus:"create",transaction:a};if(o.reconnect&&(G=!1,s.janus="claim",s.session_id=J,R&&(R.onopen=null,R.onerror=null,R.onclose=null,E&&(clearTimeout(E),E=null))),null!=V&&(s.token=V),null!=U&&(s.apisecret=U),null===D&&d.isArray(I)&&(0===(D=I[M]).indexOf("ws")?(k=!0,d.log("Server #"+(M+1)+": trying WebSockets to contact Janus ("+D+")")):(k=!1,d.log("Server #"+(M+1)+": trying REST API to contact Janus ("+D+")"))),k)for(var c in R=d.newWebSocket(D,"janus-protocol"),P={error:function(){return d.error("Error connecting to the Janus WebSockets server... "+D),d.isArray(I)&&!o.reconnect?++M==I.length?void o.error("Error connecting to any of the provided Janus servers: Is the server down?"):(D=null,void setTimeout(function(){i(o)},200)):void o.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){_[a]=function(e){return d.debug(e),"success"!==e.janus?(d.error("Ooops: "+e.error.code+" "+e.error.reason),void o.error(e.error.reason)):(E=setTimeout(r,F),G=!0,J=e.session_id?e.session_id:e.data.id,o.reconnect?d.log("Claimed session: "+J):d.log("Created session: "+J),d.sessions[J]=W,o.success(),void 0)},R.send(JSON.stringify(s))},message:function(e){n(JSON.parse(e.data))},close:function(){null!==D&&G&&(G=!1,e.error("Lost connection to the server (is it down?)"))}})R.addEventListener(c,P[c]);else d.httpAPICall(D,{verb:"POST",withCredentials:L,body:s,success:function(e){return d.debug(e),"success"!==e.janus?(d.error("Ooops: "+e.error.code+" "+e.error.reason),void o.error(e.error.reason)):(G=!0,J=e.session_id?e.session_id:e.data.id,o.reconnect?d.log("Claimed session: "+J):d.log("Created session: "+J),d.sessions[J]=W,t(),o.success(),void 0)},error:function(e,t){return d.error(e+":",t),d.isArray(I)&&!o.reconnect?++M==I.length?void o.error("Error connecting to any of the provided Janus servers: Is the server down?"):(D=null,void setTimeout(function(){i(o)},200)):void(""===t?o.error(e+": Is the server down?"):o.error(e+": "+t))}})}function o(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:d.noop,t.error="function"==typeof t.error?t.error:d.noop,!G)return d.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");var n=H[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return d.warn("Invalid handle"),void t.error("Invalid handle");var r=t.message,i=t.jsep,o=d.randomString(12),a={janus:"message",body:r,transaction:o};return null!==n.token&&void 0!==n.token&&(a.token=n.token),null!=U&&(a.apisecret=U),null!=i&&(a.jsep=i),d.debug("Sending message to plugin (handle="+e+"):"),d.debug(a),k?(a.session_id=J,a.handle_id=e,_[o]=function(e){if(d.debug("Message sent!"),d.debug(e),"success"===e.janus){var n=e.plugindata;if(null==n)return d.warn("Request succeeded, but missing plugindata..."),void t.success();d.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return d.debug(r),void t.success(r)}"ack"===e.janus?t.success():void 0!==e.error&&null!==e.error?(d.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(d.error("Unknown error"),t.error("Unknown error"))},void R.send(JSON.stringify(a))):void d.httpAPICall(D+"/"+J+"/"+e,{verb:"POST",withCredentials:L,body:a,success:function(e){if(d.debug("Message sent!"),d.debug(e),"success"===e.janus){var n=e.plugindata;if(null==n)return d.warn("Request succeeded, but missing plugindata..."),void t.success();d.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return d.debug(r),void t.success(r)}"ack"===e.janus?t.success():void 0!==e.error&&null!==e.error?(d.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(d.error("Unknown error"),t.error("Unknown error"))},error:function(e,n){d.error(e+":",n),t.error(e+": "+n)}})}function a(e,t){if(G){var n=H[e];if(null!=n&&null!==n.webrtcStuff&&void 0!==n.webrtcStuff){var r={janus:"trickle",candidate:t,transaction:d.randomString(12)};if(null!==n.token&&void 0!==n.token&&(r.token=n.token),null!=U&&(r.apisecret=U),d.vdebug("Sending trickle candidate (handle="+e+"):"),d.vdebug(r),k)return r.session_id=J,r.handle_id=e,void R.send(JSON.stringify(r));d.httpAPICall(D+"/"+J+"/"+e,{verb:"POST",withCredentials:L,body:r,success:function(e){d.vdebug("Candidate sent!"),d.vdebug(e),"ack"===e.janus||d.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){d.error(e+":",t)}})}else d.warn("Invalid handle")}else d.warn("Is the server down? (connected=false)")}function s(e,t){(t=t||{}).success="function"==typeof t.success?t.success:d.noop,t.error="function"==typeof t.error?t.error:d.noop;var n=H[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return d.warn("Invalid handle"),void t.error("Invalid handle");var r=n.webrtcStuff,i=t.text;return null==i?(d.warn("Invalid text"),void t.error("Invalid text")):(d.log("Sending string on data channel: "+i),r.dataChannel.send(i),t.success(),void 0)}function c(e,t){(t=t||{}).success="function"==typeof t.success?t.success:d.noop,t.error="function"==typeof t.error?t.error:d.noop;var n=H[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return d.warn("Invalid handle"),void t.error("Invalid handle");var r=n.webrtcStuff;if(null===r.dtmfSender||void 0===r.dtmfSender){if(void 0!==r.pc&&null!==r.pc){var i=r.pc.getSenders().find(function(e){return e.track&&"audio"===e.track.kind});if(!i)return d.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");r.dtmfSender=i.dtmf,r.dtmfSender&&(d.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(e){d.debug("Sent DTMF tone: "+e.tone)})}if(null===r.dtmfSender||void 0===r.dtmfSender)return d.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var o=t.dtmf;if(null==o)return d.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var a=o.tones;if(null==a)return d.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var s=o.duration;null==s&&(s=500);var c=o.gap;null==c&&(c=50),d.debug("Sending DTMF string "+a+" (duration "+s+"ms, gap "+c+"ms)"),r.dtmfSender.insertDTMF(a,s,c)}function u(e,t){(t=t||{}).success="function"==typeof t.success?t.success:d.noop,t.error="function"==typeof t.error?t.error:d.noop;var n=!0;void 0!==t.asyncRequest&&null!==t.asyncRequest&&(n=!0===t.asyncRequest),d.log("Destroying handle "+e+" (async="+n+")"),b(e);var r=H[e];if(null==r||r.detached)return delete H[e],void t.success();if(!G)return d.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");var i={janus:"detach",transaction:d.randomString(12)};return null!==r.token&&void 0!==r.token&&(i.token=r.token),null!=U&&(i.apisecret=U),k?(i.session_id=J,i.handle_id=e,R.send(JSON.stringify(i)),delete H[e],void t.success()):void d.httpAPICall(D+"/"+J+"/"+e,{verb:"POST",async:n,withCredentials:L,body:i,success:function(n){d.log("Destroyed handle:"),d.debug(n),"success"!==n.janus&&d.error("Ooops: "+n.error.code+" "+n.error.reason),delete H[e],t.success()},error:function(n,r){d.error(n+":",r),delete H[e],t.success()}})}function p(e,t,n,r,i){var o=H[e];if(null==o||null===o.webrtcStuff||void 0===o.webrtcStuff)return d.warn("Invalid handle"),void r.error("Invalid handle");var s=o.webrtcStuff;d.debug("streamsDone:",i),i&&(d.debug("  -- Audio tracks:",i.getAudioTracks()),d.debug("  -- Video tracks:",i.getVideoTracks()));var c=!1;if(s.myStream&&n.update&&!s.streamExternal){if((!n.update&&S(n)||n.update&&(n.addAudio||n.replaceAudio))&&i.getAudioTracks()&&i.getAudioTracks().length)if(s.myStream.addTrack(i.getAudioTracks()[0]),n.replaceAudio&&"firefox"===d.webRTCAdapter.browserDetails.browser)for(var u in d.log("Replacing audio track:",i.getAudioTracks()[0]),s.pc.getSenders())(f=s.pc.getSenders()[u])&&f.track&&"audio"===f.track.kind&&f.replaceTrack(i.getAudioTracks()[0]);else if("firefox"===d.webRTCAdapter.browserDetails.browser&&59<=d.webRTCAdapter.browserDetails.version){d.log((n.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]);var p=null;if((v=s.pc.getTransceivers())&&0<v.length)for(var l in v)if((h=v[l]).sender&&h.sender.track&&"audio"===h.sender.track.kind||h.receiver&&h.receiver.track&&"audio"===h.receiver.track.kind){p=h;break}p&&p.sender?p.sender.replaceTrack(i.getVideoTracks()[0]):s.pc.addTrack(i.getVideoTracks()[0],i)}else d.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",i.getAudioTracks()[0]),s.pc.addTrack(i.getAudioTracks()[0],i);if((!n.update&&w(n)||n.update&&(n.addVideo||n.replaceVideo))&&i.getVideoTracks()&&i.getVideoTracks().length)if(s.myStream.addTrack(i.getVideoTracks()[0]),n.replaceVideo&&"firefox"===d.webRTCAdapter.browserDetails.browser)for(var u in d.log("Replacing video track:",i.getVideoTracks()[0]),s.pc.getSenders()){var f;(f=s.pc.getSenders()[u])&&f.track&&"video"===f.track.kind&&f.replaceTrack(i.getVideoTracks()[0])}else if("firefox"===d.webRTCAdapter.browserDetails.browser&&59<=d.webRTCAdapter.browserDetails.version){d.log((n.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]);var v,m=null;if((v=s.pc.getTransceivers())&&0<v.length)for(var l in v){var h;if((h=v[l]).sender&&h.sender.track&&"video"===h.sender.track.kind||h.receiver&&h.receiver.track&&"video"===h.receiver.track.kind){m=h;break}}m&&m.sender?m.sender.replaceTrack(i.getVideoTracks()[0]):s.pc.addTrack(i.getVideoTracks()[0],i)}else d.log((n.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]),s.pc.addTrack(i.getVideoTracks()[0],i)}else s.myStream=i,c=!0;if(!s.pc){var g={iceServers:A,iceTransportPolicy:O,bundlePolicy:x},y={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===j&&y.optional.push({googIPv6:!0}),r.rtcConstraints&&"object"==typeof r.rtcConstraints)for(var l in d.debug("Adding custom PeerConnection constraints:",r.rtcConstraints),r.rtcConstraints)y.optional.push(r.rtcConstraints[l]);"edge"===d.webRTCAdapter.browserDetails.browser&&(g.bundlePolicy="max-bundle"),d.log("Creating PeerConnection"),d.debug(y),s.pc=new RTCPeerConnection(g,y),d.debug(s.pc),s.pc.getStats&&(s.volume={},s.bitrate.value="0 kbits/sec"),d.log("Preparing local SDP and gathering candidates (trickle="+s.trickle+")"),s.pc.oniceconnectionstatechange=function(e){s.pc&&o.iceState(s.pc.iceConnectionState)},s.pc.onicecandidate=function(t){if(null==t.candidate||"edge"===d.webRTCAdapter.browserDetails.browser&&0<t.candidate.candidate.indexOf("endOfCandidates"))d.log("End of candidates."),(s.iceDone=!0)===s.trickle?a(e,{completed:!0}):function(e,t){(t=t||{}).success="function"==typeof t.success?t.success:d.noop,t.error="function"==typeof t.error?t.error:d.noop;var n=H[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return d.warn("Invalid handle, not sending anything");var r=n.webrtcStuff;return d.log("Sending offer/answer SDP..."),null===r.mySdp||void 0===r.mySdp?d.warn("Local SDP instance is invalid, not sending anything..."):(r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp},!1===r.trickle&&(r.mySdp.trickle=!1),d.debug(t),r.sdpSent=!0,t.success(r.mySdp),void 0)}(e,r);else{var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===s.trickle&&a(e,n)}},s.pc.ontrack=function(e){d.log("Handling Remote Track"),d.debug(e),e.streams&&(s.remoteStream=e.streams[0],o.onremotestream(s.remoteStream),e.track&&!e.track.onended&&(d.log("Adding onended callback to track:",e.track),e.track.onended=function(e){d.log("Remote track removed:",e),s.remoteStream&&(s.remoteStream.removeTrack(e.target),o.onremotestream(s.remoteStream))}))}}if(c&&null!=i&&(d.log("Adding local stream"),i.getTracks().forEach(function(e){d.log("Adding local track:",e),s.pc.addTrack(e,i)})),function(e){return d.debug("isDataEnabled:",e),"edge"==d.webRTCAdapter.browserDetails.browser?(d.warn("Edge doesn't support data channels yet"),!1):null!=e&&!0===e.data}(n)&&!s.dataChannel){d.log("Creating data channel");var b=function(){var e=null!==s.dataChannel?s.dataChannel.readyState:"null";d.log("State change on data channel: "+e),"open"===e&&o.ondataopen()};s.dataChannel=s.pc.createDataChannel("JanusDataChannel",{ordered:!1}),s.dataChannel.onmessage=function(e){d.log("Received message on data channel: "+e.data),o.ondata(e.data)},s.dataChannel.onopen=b,s.dataChannel.onclose=b,s.dataChannel.onerror=function(e){d.error("Got error on data channel:",e)}}s.myStream&&o.onlocalstream(s.myStream),null==t?function(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:d.noop,n.error="function"==typeof n.error?n.error:d.noop;var r=H[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return d.warn("Invalid handle"),n.error("Invalid handle");var i=r.webrtcStuff,o=!0===n.simulcast;d.log(o?"Creating offer (iceDone="+i.iceDone+", simulcast="+o+")":"Creating offer (iceDone="+i.iceDone+")");var a={};if("firefox"===d.webRTCAdapter.browserDetails.browser&&59<=d.webRTCAdapter.browserDetails.version){var s=null,c=null,u=i.pc.getTransceivers();if(u&&0<u.length)for(var p in u){var l=u[p];l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind?s||(s=l):(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind)&&(c||(c=l))}var f=S(t),v=T(t);f||v?f&&v?s&&(s.direction="sendrecv",d.log("Setting audio transceiver to sendrecv:",s)):f&&!v?s&&(s.direction="sendonly",d.log("Setting audio transceiver to sendonly:",s)):!f&&v&&(s?(s.direction="recvonly",d.log("Setting audio transceiver to recvonly:",s)):(s=i.pc.addTransceiver("audio",{direction:"recvonly"}),d.log("Adding recvonly audio transceiver:",s))):t.removeAudio&&s&&(s.direction="inactive",d.log("Setting audio transceiver to inactive:",s));var m=w(t),h=C(t);m||h?m&&h?c&&(c.direction="sendrecv",d.log("Setting video transceiver to sendrecv:",c)):m&&!h?c&&(c.direction="sendonly",d.log("Setting video transceiver to sendonly:",c)):!m&&h&&(c?(c.direction="recvonly",d.log("Setting video transceiver to recvonly:",c)):(c=i.pc.addTransceiver("video",{direction:"recvonly"}),d.log("Adding recvonly video transceiver:",c))):t.removeVideo&&c&&(c.direction="inactive",d.log("Setting video transceiver to inactive:",c))}else a.offerToReceiveAudio=T(t),a.offerToReceiveVideo=C(t);!0===n.iceRestart&&(a.iceRestart=!0),d.debug(a);var g=w(t);if(g&&o&&"firefox"===d.webRTCAdapter.browserDetails.browser){d.log("Enabling Simulcasting for Firefox (RID)");var y=i.pc.getSenders()[1];d.log(y);var b=y.getParameters();d.log(b),y.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}i.pc.createOffer(a).then(function(e){if(d.debug(e),d.log("Setting local description"),g&&o&&("chrome"===d.webRTCAdapter.browserDetails.browser?(d.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var t=e.split("\r\n"),n=!1,r=[-1],i=[-1],o=null,a=null,s=null,c=null,u=-1,p=0;p<t.length;p++){var l=t[p].match(/m=(\w+) */);if(l){var f=l[1];if("video"===f){if(!(r[0]<0)){u=p;break}n=!0}else if(-1<r[0]){u=p;break}}else if(n){var v=t[p].match(/a=ssrc-group:FID (\d+) (\d+)/);if(v)r[0]=v[1],i[0]=v[2],t.splice(p,1),p--;else{if(r[0]){var m=t[p].match("a=ssrc:"+r[0]+" cname:(.+)");if(m&&(o=m[1]),(m=t[p].match("a=ssrc:"+r[0]+" msid:(.+)"))&&(a=m[1]),(m=t[p].match("a=ssrc:"+r[0]+" mslabel:(.+)"))&&(s=m[1]),(m=t[p].match("a=ssrc:"+r+" label:(.+)"))&&(c=m[1]),0===t[p].indexOf("a=ssrc:"+i)){t.splice(p,1),p--;continue}if(0===t[p].indexOf("a=ssrc:"+r[0])){t.splice(p,1),p--;continue}}0!=t[p].length||(t.splice(p,1),p--)}}}if(r[0]<0){n=!(u=-1);for(var p=0;p<t.length;p++){var l=t[p].match(/m=(\w+) */);if(l){var f=l[1];if("video"===f){if(!(r[0]<0)){u=p;break}n=!0}else if(-1<r[0]){u=p;break}}else if(n){if(r[0]<0){var h=t[p].match(/a=ssrc:(\d+)/);if(h){r[0]=h[1],t.splice(p,1),p--;continue}}else{var m=t[p].match("a=ssrc:"+r[0]+" cname:(.+)");if(m&&(o=m[1]),(m=t[p].match("a=ssrc:"+r[0]+" msid:(.+)"))&&(a=m[1]),(m=t[p].match("a=ssrc:"+r[0]+" mslabel:(.+)"))&&(s=m[1]),(m=t[p].match("a=ssrc:"+r[0]+" label:(.+)"))&&(c=m[1]),0===t[p].indexOf("a=ssrc:"+i[0])){t.splice(p,1),p--;continue}if(0===t[p].indexOf("a=ssrc:"+r[0])){t.splice(p,1),p--;continue}}0!=t[p].length||(t.splice(p,1),p--)}}}if(r[0]<0)return d.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;0>u&&(u=t.length),r[1]=Math.floor(4294967295*Math.random()),r[2]=Math.floor(4294967295*Math.random()),i[1]=Math.floor(4294967295*Math.random()),i[2]=Math.floor(4294967295*Math.random());for(var p=0;p<r.length;p++)o&&(t.splice(u,0,"a=ssrc:"+r[p]+" cname:"+o),u++),a&&(t.splice(u,0,"a=ssrc:"+r[p]+" msid:"+a),u++),s&&(t.splice(u,0,"a=ssrc:"+r[p]+" mslabel:"+s),u++),c&&(t.splice(u,0,"a=ssrc:"+r[p]+" label:"+c),u++),o&&(t.splice(u,0,"a=ssrc:"+i[p]+" cname:"+o),u++),a&&(t.splice(u,0,"a=ssrc:"+i[p]+" msid:"+a),u++),s&&(t.splice(u,0,"a=ssrc:"+i[p]+" mslabel:"+s),u++),c&&(t.splice(u,0,"a=ssrc:"+i[p]+" label:"+c),u++);return t.splice(u,0,"a=ssrc-group:FID "+r[2]+" "+i[2]),t.splice(u,0,"a=ssrc-group:FID "+r[1]+" "+i[1]),t.splice(u,0,"a=ssrc-group:FID "+r[0]+" "+i[0]),t.splice(u,0,"a=ssrc-group:SIM "+r[0]+" "+r[1]+" "+r[2]),(e=t.join("\r\n")).endsWith("\r\n")||(e+="\r\n"),e}(e.sdp)):"firefox"!==d.webRTCAdapter.browserDetails.browser&&d.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp=e.sdp,i.pc.setLocalDescription(e)["catch"](n.error),i.mediaConstraints=a,i.iceDone||i.trickle){d.log("Offer ready"),d.debug(n);var t={type:e.type,sdp:e.sdp};n.success(t)}else d.log("Waiting for all candidates...")},n.error)}(e,n,r):s.pc.setRemoteDescription(t).then(function(){if(d.log("Remote description accepted!"),s.remoteSdp=t.sdp,s.candidates&&0<s.candidates.length){for(var i in s.candidates){var o=s.candidates[i];d.debug("Adding remote candidate:",o),o&&!0!==o.completed?s.pc.addIceCandidate(o):s.pc.addIceCandidate()}s.candidates=[]}!function(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:d.noop,n.error="function"==typeof n.error?n.error:d.noop;var r=H[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return d.warn("Invalid handle"),n.error("Invalid handle");var i=r.webrtcStuff,o=!0===n.simulcast;d.log(o?"Creating answer (iceDone="+i.iceDone+", simulcast="+o+")":"Creating answer (iceDone="+i.iceDone+")");var a=null;if("firefox"===d.webRTCAdapter.browserDetails.browser&&59<=d.webRTCAdapter.browserDetails.version){a={};var s=null,c=null,u=i.pc.getTransceivers();if(u&&0<u.length)for(var p in u){var l=u[p];l.sender&&l.sender.track&&"audio"===l.sender.track.kind||l.receiver&&l.receiver.track&&"audio"===l.receiver.track.kind?s||(s=l):(l.sender&&l.sender.track&&"video"===l.sender.track.kind||l.receiver&&l.receiver.track&&"video"===l.receiver.track.kind)&&(c||(c=l))}var f=S(t),v=T(t);f||v?f&&v?s&&(s.direction="sendrecv",d.log("Setting audio transceiver to sendrecv:",s)):f&&!v?s&&(s.direction="sendonly",d.log("Setting audio transceiver to sendonly:",s)):!f&&v&&(s?(s.direction="recvonly",d.log("Setting audio transceiver to recvonly:",s)):(s=i.pc.addTransceiver("audio",{direction:"recvonly"}),d.log("Adding recvonly audio transceiver:",s))):t.removeAudio&&s&&(s.direction="inactive",d.log("Setting audio transceiver to inactive:",s));var m=w(t),h=C(t);m||h?m&&h?c&&(c.direction="sendrecv",d.log("Setting video transceiver to sendrecv:",c)):m&&!h?c&&(c.direction="sendonly",d.log("Setting video transceiver to sendonly:",c)):!m&&h&&(c?(c.direction="recvonly",d.log("Setting video transceiver to recvonly:",c)):(c=i.pc.addTransceiver("video",{direction:"recvonly"}),d.log("Adding recvonly video transceiver:",c))):t.removeVideo&&c&&(c.direction="inactive",d.log("Setting video transceiver to inactive:",c))}else a="firefox"==d.webRTCAdapter.browserDetails.browser||"edge"==d.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:T(t),offerToReceiveVideo:C(t)}:{mandatory:{OfferToReceiveAudio:T(t),OfferToReceiveVideo:C(t)}};d.debug(a);var g=w(t);if(g&&o&&"firefox"===d.webRTCAdapter.browserDetails.browser){d.log("Enabling Simulcasting for Firefox (RID)");var y=i.pc.getSenders()[1];d.log(y);var b=y.getParameters();d.log(b),y.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}i.pc.createAnswer(a).then(function(e){if(d.debug(e),d.log("Setting local description"),g&&o&&("chrome"===d.webRTCAdapter.browserDetails.browser?d.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==d.webRTCAdapter.browserDetails.browser&&d.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp=e.sdp,i.pc.setLocalDescription(e)["catch"](n.error),i.mediaConstraints=a,i.iceDone||i.trickle){var t={type:e.type,sdp:e.sdp};n.success(t)}else d.log("Waiting for all candidates...")},n.error)}(e,n,r)},r.error)}function l(e,t){function n(n,r){a.consentDialog(!1),n?t.error(n):p(e,i,o,t,r)}function r(e,t,n){d.log("Adding media constraint (screen capture)"),d.debug(e),navigator.mediaDevices.getUserMedia(e).then(function(e){n?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(n){e.addTrack(n.getAudioTracks()[0]),t(null,e)}):t(null,e)})["catch"](function(e){a.consentDialog(!1),t(e)})}(t=t||{}).success="function"==typeof t.success?t.success:d.noop,t.error="function"==typeof t.error?t.error:y;var i=t.jsep;t.media=t.media||{audio:!0,video:!0};var o=t.media,a=H[e];if(null==a||null===a.webrtcStuff||void 0===a.webrtcStuff)return d.warn("Invalid handle"),void t.error("Invalid handle");var s,c=a.webrtcStuff;if(c.trickle=(s=t.trickle,d.debug("isTrickleEnabled:",s),null==s||!0===s),void 0===c.pc||null===c.pc)o.update=!1;else if(void 0!==c.pc&&null!==c.pc)if(d.log("Updating existing media session"),o.update=!0,null!==t.stream&&void 0!==t.stream)t.stream!==c.myStream&&d.log("Renegotiation involves a new external stream");else{if(o.addAudio){if(o.replaceAudio=!1,o.removeAudio=!1,o.audioSend=!0,c.myStream&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length)return d.error("Can't add audio stream, there already is one"),void t.error("Can't add audio stream, there already is one")}else o.removeAudio?(o.replaceAudio=!1,o.addAudio=!1,o.audioSend=!1):o.replaceAudio&&(o.addAudio=!1,o.removeAudio=!1,o.audioSend=!0);if(null===c.myStream||void 0===c.myStream?(o.replaceAudio&&(o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),S(o)&&(o.addAudio=!0)):null!==c.myStream.getAudioTracks()&&void 0!==c.myStream.getAudioTracks()&&0!==c.myStream.getAudioTracks().length||(o.replaceAudio&&(o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),S(o)&&(o.addAudio=!0)),o.addVideo){if(o.replaceVideo=!1,o.removeVideo=!1,o.videoSend=!0,c.myStream&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length)return d.error("Can't add video stream, there already is one"),void t.error("Can't add video stream, there already is one")}else o.removeVideo?(o.replaceVideo=!1,o.addVideo=!1,o.videoSend=!1):o.replaceVideo&&(o.addVideo=!1,o.removeVideo=!1,o.videoSend=!0);null===c.myStream||void 0===c.myStream?(o.replaceVideo&&(o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),w(o)&&(o.addVideo=!0)):null!==c.myStream.getVideoTracks()&&void 0!==c.myStream.getVideoTracks()&&0!==c.myStream.getVideoTracks().length||(o.replaceVideo&&(o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),w(o)&&(o.addVideo=!0)),o.addData&&(o.data=!0)}if(o.update&&!c.streamExternal){if(o.removeAudio||o.replaceAudio){if(c.myStream&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length){var u=c.myStream.getAudioTracks()[0];d.log("Removing audio track:",u),c.myStream.removeTrack(u);try{u.stop()}catch(s){}}if(c.pc.getSenders()&&c.pc.getSenders().length){var l=!0;if(o.replaceAudio&&"firefox"===d.webRTCAdapter.browserDetails.browser&&(l=!1),l)for(var f in c.pc.getSenders())(u=c.pc.getSenders()[f])&&u.track&&"audio"===u.track.kind&&(d.log("Removing audio sender:",u),c.pc.removeTrack(u))}}if(o.removeVideo||o.replaceVideo){if(c.myStream&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length){u=c.myStream.getVideoTracks()[0],d.log("Removing video track:",u),c.myStream.removeTrack(u);try{u.stop()}catch(s){}}if(c.pc.getSenders()&&c.pc.getSenders().length){var v=!0;if(o.replaceVideo&&"firefox"===d.webRTCAdapter.browserDetails.browser&&(v=!1),v)for(var f in c.pc.getSenders())(u=c.pc.getSenders()[f])&&u.track&&"video"===u.track.kind&&(d.log("Removing video sender:",u),c.pc.removeTrack(u))}}}if(null!==t.stream&&void 0!==t.stream){var m=t.stream;
if(d.log("MediaStream provided by the application"),d.debug(m),o.update&&c.myStream&&c.myStream!==t.stream&&!c.streamExternal){try{var h=c.myStream.getTracks();for(var g in h){var b=h[g];d.log(b),null!=b&&b.stop()}}catch(s){}c.myStream=null}return c.streamExternal=!0,void p(e,i,o,t,m)}if(S(o)||w(o)){var T={mandatory:{},optional:[]};a.consentDialog(!0);var C=S(o);!0===C&&null!=o&&null!=o&&"object"==typeof o.audio&&(C=o.audio);var k=w(o);if(!0===k&&null!=o&&null!=o)if(!(!0===t.simulcast)||i||void 0!==o.video&&!1!==o.video||(o.video="hires"),o.video&&"screen"!=o.video&&"window"!=o.video)if("object"==typeof o.video)k=o.video;else{var R=0,P=0;"lowres"===o.video?(P=240,R=320):"lowres-16:9"===o.video?(P=180,R=320):"hires"===o.video||"hires-16:9"===o.video||"hdres"===o.video?(P=720,R=1280):"fhdres"===o.video?(P=1080,R=1920):"4kres"===o.video?(P=2160,R=3840):("stdres"===o.video?P=480:"stdres-16:9"===o.video?P=360:(d.log("Default video setting is stdres 4:3"),P=480),R=640),d.log("Adding media constraint:",o.video),d.log("Adding video constraint:",k={height:{ideal:P},width:{ideal:R}})}else if("screen"===o.video||"window"===o.video){if(o.screenshareFrameRate||(o.screenshareFrameRate=3),navigator.getDisplayMedia)return void navigator.getDisplayMedia({video:!0}).then(function(n){a.consentDialog(!1),S(o)?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(r){n.addTrack(r.getAudioTracks()[0]),p(e,i,o,t,n)}):p(e,i,o,t,n)},function(e){a.consentDialog(!1),t.error(e)});if("chrome"===d.webRTCAdapter.browserDetails.browser){var E=d.webRTCAdapter.browserDetails.version,I=33;window.navigator.userAgent.match("Linux")&&(I=35),E>=26&&I>=E?r(T={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate,chromeMediaSource:"screen"}},audio:S(o)},n):d.extension.getScreen(function(e,i){return e?(a.consentDialog(!1),t.error(e)):((T={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=i,void r(T,n,S(o)))})}else if(window.navigator.userAgent.match("Firefox")){if(!(33<=parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10))){var M=new Error("NavigatorUserMediaError");return M.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",a.consentDialog(!1),void t.error(M)}r(T={video:{mozMediaSource:o.video,mediaSource:o.video},audio:S(o)},function(e,t){if(n(e,t),!e)var r=t.currentTime,i=window.setInterval(function(){t||window.clearInterval(i),t.currentTime==r&&(window.clearInterval(i),t.onended&&t.onended()),r=t.currentTime},500)})}return}null!=o&&"screen"===o.video||navigator.mediaDevices.enumerateDevices().then(function(n){var r,s,c=n.some(function(e){return"audioinput"===e.kind}),u=function(e){if(d.debug("isScreenSendEnabled:",e),null==e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var t=e.video.mandatory;return t.chromeMediaSource?"desktop"===t.chromeMediaSource||"screen"===t.chromeMediaSource:t.mozMediaSource?"window"===t.mozMediaSource||"screen"===t.mozMediaSource:t.mediaSource?"window"===t.mediaSource||"screen"===t.mediaSource:!1}(o)||n.some(function(e){return"videoinput"===e.kind}),l=S(o),f=w(o),v=(d.debug("isAudioSendRequired:",r=o),null!=r&&!1!==r.audio&&!1!==r.audioSend&&void 0!==r.failIfNoAudio&&null!==r.failIfNoAudio&&!0===r.failIfNoAudio),m=(d.debug("isVideoSendRequired:",s=o),null!=s&&!1!==s.video&&!1!==s.videoSend&&void 0!==s.failIfNoVideo&&null!==s.failIfNoVideo&&!0===s.failIfNoVideo);if(l||f||v||m){var h=!!l&&c,g=!!f&&u;if(!h&&!g)return a.consentDialog(!1),t.error("No capture device found"),!1;if(!h&&v)return a.consentDialog(!1),t.error("Audio capture is required, but no capture device found"),!1;if(!g&&m)return a.consentDialog(!1),t.error("Video capture is required, but no capture device found"),!1}var y={audio:!!c&&C,video:!!u&&k};d.debug("getUserMedia constraints",y),navigator.mediaDevices.getUserMedia(y).then(function(n){a.consentDialog(!1),p(e,i,o,t,n)})["catch"](function(e){a.consentDialog(!1),t.error({code:e.code,name:e.name,message:e.message})})})["catch"](function(e){a.consentDialog(!1),t.error("enumerateDevices error",e)})}else p(e,i,o,t)}function f(e,t){(t=t||{}).success="function"==typeof t.success?t.success:d.noop,t.error="function"==typeof t.error?t.error:y;var n=t.jsep,r=H[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return d.warn("Invalid handle"),void t.error("Invalid handle");var i=r.webrtcStuff;if(null!=n){if(null===i.pc)return d.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");i.pc.setRemoteDescription(n).then(function(){if(d.log("Remote description accepted!"),i.remoteSdp=n.sdp,i.candidates&&0<i.candidates.length){for(var e in i.candidates){var r=i.candidates[e];d.debug("Adding remote candidate:",r),r&&!0!==r.completed?i.pc.addIceCandidate(r):i.pc.addIceCandidate()}i.candidates=[]}t.success()},t.error)}else t.error("Invalid JSEP")}function v(e,t){var n=H[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return d.warn("Invalid handle"),0;var r=t?"remote":"local",i=n.webrtcStuff;return i.volume[r]||(i.volume[r]={value:0}),i.pc.getStats&&"chrome"===d.webRTCAdapter.browserDetails.browser?!t||null!==i.remoteStream&&void 0!==i.remoteStream?t||null!==i.myStream&&void 0!==i.myStream?null===i.volume[r].timer||void 0===i.volume[r].timer?(d.log("Starting "+r+" volume monitor"),i.volume[r].timer=setInterval(function(){i.pc.getStats(function(e){for(var n=e.result(),o=0;o<n.length;o++){var a=n[o];"ssrc"==a.type&&(t&&a.stat("audioOutputLevel")?i.volume[r].value=parseInt(a.stat("audioOutputLevel")):!t&&a.stat("audioInputLevel")&&(i.volume[r].value=parseInt(a.stat("audioInputLevel"))))}})},200),0):i.volume[r].value:(d.warn("Local stream unavailable"),0):(d.warn("Remote stream unavailable"),0):(d.warn("Getting the "+r+" volume unsupported by browser"),0)}function m(e,t){var n=H[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return d.warn("Invalid handle"),!0;var r=n.webrtcStuff;return null===r.pc||void 0===r.pc?(d.warn("Invalid PeerConnection"),!0):void 0===r.myStream||null===r.myStream?(d.warn("Invalid local MediaStream"),!0):t?null===r.myStream.getVideoTracks()||void 0===r.myStream.getVideoTracks()||0===r.myStream.getVideoTracks().length?(d.warn("No video track"),!0):!r.myStream.getVideoTracks()[0].enabled:null===r.myStream.getAudioTracks()||void 0===r.myStream.getAudioTracks()||0===r.myStream.getAudioTracks().length?(d.warn("No audio track"),!0):!r.myStream.getAudioTracks()[0].enabled}function h(e,t,n){var r=H[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return d.warn("Invalid handle"),!1;var i=r.webrtcStuff;return null===i.pc||void 0===i.pc?(d.warn("Invalid PeerConnection"),!1):void 0===i.myStream||null===i.myStream?(d.warn("Invalid local MediaStream"),!1):t?null===i.myStream.getVideoTracks()||void 0===i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length?(d.warn("No video track"),!1):(i.myStream.getVideoTracks()[0].enabled=!n,!0):null===i.myStream.getAudioTracks()||void 0===i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length?(d.warn("No audio track"),!1):(i.myStream.getAudioTracks()[0].enabled=!n,!0)}function g(e){var t=H[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return d.warn("Invalid handle"),"Invalid handle";var n=t.webrtcStuff;return null===n.pc||void 0===n.pc?"Invalid PeerConnection":n.pc.getStats?null===n.bitrate.timer||void 0===n.bitrate.timer?(d.log("Starting bitrate timer (via getStats)"),n.bitrate.timer=setInterval(function(){n.pc.getStats().then(function(e){e.forEach(function(e){if(e){var t=!1;if(("video"===e.mediaType||-1<e.id.toLowerCase().indexOf("video"))&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(n.bitrate.bsnow=e.bytesReceived,n.bitrate.tsnow=e.timestamp,null===n.bitrate.bsbefore||null===n.bitrate.tsbefore)n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow;else{var r=n.bitrate.tsnow-n.bitrate.tsbefore;"safari"==d.webRTCAdapter.browserDetails.browser&&(r/=1e3);var i=Math.round(8*(n.bitrate.bsnow-n.bitrate.bsbefore)/r);n.bitrate.value=i+" kbits/sec",n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow}}})})},1e3),"0 kbits/sec"):n.bitrate.value:(d.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function y(e){d.error("WebRTC error:",e)}function b(e,t){d.log("Cleaning WebRTC stuff");var n=H[e];if(null!=n){var r=n.webrtcStuff;if(null!=r){if(!0===t){var i={janus:"hangup",transaction:d.randomString(12)};null!==n.token&&void 0!==n.token&&(i.token=n.token),null!=U&&(i.apisecret=U),d.debug("Sending hangup request (handle="+e+"):"),d.debug(i),k?(i.session_id=J,i.handle_id=e,R.send(JSON.stringify(i))):d.httpAPICall(D+"/"+J+"/"+e,{verb:"POST",withCredentials:L,body:i})}r.remoteStream=null,r.volume&&(r.volume.local&&r.volume.local.timer&&clearInterval(r.volume.local.timer),r.volume.remote&&r.volume.remote.timer&&clearInterval(r.volume.remote.timer)),r.volume={},r.bitrate.timer&&clearInterval(r.bitrate.timer),r.bitrate.timer=null,r.bitrate.bsnow=null,r.bitrate.bsbefore=null,r.bitrate.tsnow=null,r.bitrate.tsbefore=null,r.bitrate.value=null;try{if(!r.streamExternal&&null!==r.myStream&&void 0!==r.myStream){d.log("Stopping local stream tracks");var o=r.myStream.getTracks();for(var a in o){var s=o[a];d.log(s),null!=s&&s.stop()}}}catch(e){}r.streamExternal=!1,r.myStream=null;try{r.pc.close()}catch(e){}r.pc=null,r.candidates=null,r.mySdp=null,r.remoteSdp=null,r.iceDone=!1,r.dataChannel=null,r.dtmfSender=null}n.oncleanup()}}function S(e){return d.debug("isAudioSendEnabled:",e),null==e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function T(e){return d.debug("isAudioRecvEnabled:",e),null==e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function w(e){return d.debug("isVideoSendEnabled:",e),null==e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function C(e){return d.debug("isVideoRecvEnabled:",e),null==e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}if(void 0===d.initDone)return e.error("Library not initialized"),{};if(!d.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(d.log("Library initialized: "+d.initDone),(e=e||{}).success="function"==typeof e.success?e.success:d.noop,e.error="function"==typeof e.error?e.error:d.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:d.noop,null===e.server||void 0===e.server)return e.error("Invalid server url"),{};var k=!1,R=null,P={},E=null,I=null,M=0,D=e.server;d.isArray(D)?(d.log("Multiple servers provided ("+D.length+"), will use the first that works"),D=null,I=e.server,d.debug(I)):0===D.indexOf("ws")?(k=!0,d.log("Using WebSockets to contact Janus: "+D)):(k=!1,d.log("Using REST API to contact Janus: "+D));var A=e.iceServers;null==A&&(A=[{urls:"stun:stun.l.google.com:19302"}]);var O=e.iceTransportPolicy,x=e.bundlePolicy,j=e.ipv6;null==j&&(j=!1);var L=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(L=!0===e.withCredentials);var N=null;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(N=e.max_poll_events),1>N&&(N=1);var V=null;void 0!==e.token&&null!==e.token&&(V=e.token);var U=null;void 0!==e.apisecret&&null!==e.apisecret&&(U=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var F=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(F=e.keepAlivePeriod),isNaN(F)&&(F=25e3);var B=6e4;void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(B=e.longPollTimeout),isNaN(B)&&(B=6e4);var G=!1,J=null,H={},W=this,q=0,_={};i(e),this.getServer=function(){return D},this.isConnected=function(){return G},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:d.noop,e.error="function"==typeof e.error?e.error:d.noop,e.reconnect=!0,i(e)},this.getSessionId=function(){return J},this.destroy=function(t){!function(t){(t=t||{}).success="function"==typeof t.success?t.success:d.noop;var n=!0;void 0!==t.asyncRequest&&null!==t.asyncRequest&&(n=!0===t.asyncRequest);var r=!0;if(void 0!==t.notifyDestroyed&&null!==t.notifyDestroyed&&(r=!0===t.notifyDestroyed),d.log("Destroying session "+J+" (async="+n+")"),!G)return d.warn("Is the server down? (connected=false)"),t.success();if(null==J)return d.warn("No session to destroy"),t.success(),r&&e.destroyed();delete d.sessions[J];var i={janus:"destroy",transaction:d.randomString(12)};if(null!=V&&(i.token=V),null!=U&&(i.apisecret=U),k){i.session_id=J;var o=function(){for(var e in P)R.removeEventListener(e,P[e]);R.removeEventListener("message",a),R.removeEventListener("error",s),E&&clearTimeout(E),R.close()},a=function(n){var a=JSON.parse(n.data);a.session_id==i.session_id&&a.transaction==i.transaction&&(o(),t.success(),r&&e.destroyed())},s=function(n){o(),t.error("Failed to destroy the server: Is the server down?"),r&&e.destroyed()};return R.addEventListener("message",a),R.addEventListener("error",s),R.send(JSON.stringify(i))}d.httpAPICall(D+"/"+J,{verb:"POST",async:n,withCredentials:L,body:i,success:function(n){d.log("Destroyed session:"),d.debug(n),J=null,G=!1,"success"!==n.janus&&d.error("Ooops: "+n.error.code+" "+n.error.reason),t.success(),r&&e.destroyed()},error:function(n,i){d.error(n+":",i),J=null,G=!1,t.success(),r&&e.destroyed()}})}(t)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:d.noop,e.error="function"==typeof e.error?e.error:d.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:d.noop,e.iceState="function"==typeof e.iceState?e.iceState:d.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:d.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:d.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:d.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:d.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:d.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:d.noop,e.ondata="function"==typeof e.ondata?e.ondata:d.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:d.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:d.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:d.noop,!G)return d.warn("Is the server down? (connected=false)"),e.error("Is the server down? (connected=false)");var t=e.plugin;if(null==t)return d.error("Invalid plugin"),e.error("Invalid plugin");var n=e.opaqueId,r=e.token?e.token:V,i=d.randomString(12),a={janus:"attach",plugin:t,opaque_id:n,transaction:i};return null!=r&&(a.token=r),null!=U&&(a.apisecret=U),k?(_[i]=function(n){if(d.debug(n),"success"!==n.janus)return d.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var i=n.data.id;d.log("Created handle: "+i);var a={session:W,plugin:t,id:i,token:r,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return i},getPlugin:function(){return t},getVolume:function(){return v(i,!0)},getRemoteVolume:function(){return v(i,!0)},getLocalVolume:function(){return v(i,!1)},isAudioMuted:function(){return m(i,!1)},muteAudio:function(){return h(i,!1,!0)},unmuteAudio:function(){return h(i,!1,!1)},isVideoMuted:function(){return m(i,!0)},muteVideo:function(){return h(i,!0,!0)},unmuteVideo:function(){return h(i,!0,!1)},getBitrate:function(){return g(i)},send:function(e){o(i,e)},data:function(e){s(i,e)},dtmf:function(e){c(i,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){l(i,e)},createAnswer:function(e){l(i,e)},handleRemoteJsep:function(e){f(i,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){b(i,!0===e)},detach:function(e){u(i,e)}};H[i]=a,e.success(a)},a.session_id=J,R.send(JSON.stringify(a))):void d.httpAPICall(D+"/"+J,{verb:"POST",withCredentials:L,body:a,success:function(n){if(d.debug(n),"success"!==n.janus)return d.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var i=n.data.id;d.log("Created handle: "+i);var a={session:W,plugin:t,id:i,token:r,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return i},getPlugin:function(){return t},getVolume:function(){return v(i,!0)},getRemoteVolume:function(){return v(i,!0)},getLocalVolume:function(){return v(i,!1)},isAudioMuted:function(){return m(i,!1)},muteAudio:function(){return h(i,!1,!0)},unmuteAudio:function(){return h(i,!1,!1)},isVideoMuted:function(){return m(i,!0)},muteVideo:function(){return h(i,!0,!0)},unmuteVideo:function(){return h(i,!0,!1)},getBitrate:function(){return g(i)},send:function(e){o(i,e)},data:function(e){s(i,e)},dtmf:function(e){c(i,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){l(i,e)},createAnswer:function(e){l(i,e)},handleRemoteJsep:function(e){f(i,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){b(i,!0===e)},detach:function(e){u(i,e)}};H[i]=a,e.success(a)},error:function(e,t){d.error(e+":",t)}})}(e)}}var u,p=function(e,t){return(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},l="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},f=!0,v=!0,m={extractVersion:t,wrapPeerConnectionEvent:function(e,t,n){if(e.RTCPeerConnection){var r=e.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return i.apply(this,arguments);var o=function(e){var t=n(e);t&&r(t)};return this.n=this.n||{},this.n[r]=o,i.apply(this,[e,o])};var o=r.removeEventListener;r.removeEventListener=function(e,n){if(e!==t||!this.n||!this.n[n])return o.apply(this,arguments);var r=this.n[n];return delete this.n[n],o.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(f=e)?"adapter.js logging disabled":"adapter.js logging enabled"},disableWarnings:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(v=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},log:function(){if("object"==typeof window){if(f)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(e,t){v&&console.warn(e+" is deprecated, please use "+t+" instead.")},detectBrowser:function(e){var n=e&&e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(n.mozGetUserMedia)r.browser="firefox",r.version=t(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia)r.browser="chrome",r.version=t(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.mediaDevices&&n.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=t(n.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=t(n.userAgent,/AppleWebKit\/(\d+)\./,1)}return r}},h=m.log,g=m.log,y={shimGetUserMedia:function(e){var t=m.detectBrowser(e),n=e&&e.navigator,r=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];var o={};"number"==typeof r.ideal?(o[i("min",n)]=r.ideal,t.optional.push(o),(o={})[i("max",n)]=r.ideal):o[i("",n)]=r.ideal,t.optional.push(o)}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach(function(e){void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,i){if(61<=t.version)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){var o=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};o((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),o(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=r(e.audio)}if(e&&"object"==typeof e.video){var a=e.video.facingMode;a=a&&("object"==typeof a?a:{ideal:a});var s,c=t.version<66;if(a&&("user"===a.exact||"environment"===a.exact||"user"===a.ideal||"environment"===a.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||c)&&(delete e.video.facingMode,"environment"===a.exact||"environment"===a.ideal?s=["back","rear"]:"user"!==a.exact&&"user"!==a.ideal||(s=["front"]),s))return n.mediaDevices.enumerateDevices().then(function(t){var n=(t=t.filter(function(e){return"videoinput"===e.kind})).find(function(e){return s.some(function(t){return-1!==e.label.toLowerCase().indexOf(t)})});return!n&&t.length&&-1!==s.indexOf("back")&&(n=t[t.length-1]),n&&(e.video.deviceId=a.exact?{exact:n.deviceId}:{ideal:n.deviceId}),e.video=r(e.video),h("chrome: "+JSON.stringify(e)),i(e)});e.video=r(e.video)}return h("chrome: "+JSON.stringify(e)),i(e)},o=function(e){return 64<=t.version?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};n.getUserMedia=function(e,t,r){i(e,function(e){n.webkitGetUserMedia(e,t,function(e){r&&r(o(e))})})};var a=function(e){return new Promise(function(t,r){n.getUserMedia(e,t,r)})};if(n.mediaDevices||(n.mediaDevices={getUserMedia:a,enumerateDevices:function(){return new Promise(function(t){var n={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:n[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),n.mediaDevices.getUserMedia){var s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(e){return i(e,function(e){return s(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(o(e))})})}}else n.mediaDevices.getUserMedia=function(e){return a(e)};void 0===n.mediaDevices.addEventListener&&(n.mediaDevices.addEventListener=function(){h("Dummy mediaDevices.addEventListener called.")}),void 0===n.mediaDevices.removeEventListener&&(n.mediaDevices.removeEventListener=function(){h("Dummy mediaDevices.removeEventListener called.")})},shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)"RTCRtpTransceiver"in e||m.wrapPeerConnectionEvent(e,"track",function(e){return e.transceiver||(e.transceiver={receiver:e.receiver}),e});else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this.e},set:function(e){this.e&&this.removeEventListener("track",this.e),this.addEventListener("track",this.e=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var n=this;return n.t||(n.t=function(t){t.stream.addEventListener("addtrack",function(r){var i;i=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===r.track.id}):{track:r.track};var o=new Event("track");o.track=r.track,o.receiver=i,o.transceiver={receiver:i},o.streams=[t.stream],n.dispatchEvent(o)}),t.stream.getTracks().forEach(function(r){var i;i=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===r.id}):{track:r};var o=new Event("track");o.track=r,o.receiver=i,o.transceiver={receiver:i},o.streams=[t.stream],n.dispatchEvent(o)})},n.addEventListener("addstream",n.t)),t.apply(n,arguments)}}},shimGetSendersWithDtmf:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this.i&&("audio"===t.kind?this.i=e.createDTMFSender(t):this.i=null),this.i},r:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this.o=this.o||[],this.o.slice()};var n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){var i=n.apply(this,arguments);return i||(i=t(this,e),this.o.push(i)),i};var r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);var t=this.o.indexOf(e);-1!==t&&this.o.splice(t,1)}}var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var n=this;n.o=n.o||[],i.apply(n,[e]),e.getTracks().forEach(function(e){n.o.push(t(n,e))})};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t.o=t.o||[],o.apply(t,[e]),e.getTracks().forEach(function(e){var n=t.o.find(function(t){return t.track===e});n&&t.o.splice(t.o.indexOf(n),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var a=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=a.apply(e,[]);return t.forEach(function(t){t.r=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this.i&&("audio"===this.track.kind?this.i=this.r.createDTMFSender(this.track):this.i=null),this.i}})}},shimSenderReceiverGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,n=t.apply(e,[]);return n.forEach(function(t){t.r=e}),n});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e.r=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this.r.getStats().then(function(t){return n(t,e.track,!0)})}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var i=e.RTCPeerConnection.prototype.getReceivers;i&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=i.apply(e,[]);return t.forEach(function(t){t.r=e}),t}),m.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver.r=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this.r.getStats().then(function(t){return n(t,e.track,!1)})}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof e.MediaStreamTrack){var t,n,r,i=arguments[0];return this.getSenders().forEach(function(e){e.track===i&&(t?r=!0:t=e)}),this.getReceivers().forEach(function(e){return e.track===i&&(n?r=!0:n=e),e.track===i}),r||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return o.apply(this,arguments)}}}},shimSourceObject:function(e){var t=e&&e.URL;"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.a},set:function(e){var n=this;this.a=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e)}),e.addEventListener("removetrack",function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e)})):this.src=""}}))},shimAddTrackRemoveTrackWithNative:function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this.u=this.u||{},Object.keys(this.u).map(function(t){return e.u[t][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this.u=this.u||{};var r=t.apply(this,arguments);return this.u[n.id]?-1===this.u[n.id].indexOf(r)&&this.u[n.id].push(r):this.u[n.id]=[n,r],r};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this.u=this.u||{},e.getTracks().forEach(function(e){if(t.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")});var r=t.getSenders();n.apply(this,arguments);var i=t.getSenders().filter(function(e){return-1===r.indexOf(e)});this.u[e.id]=[e].concat(i)};var r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this.u=this.u||{},delete this.u[e.id],r.apply(this,arguments)};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this.u=this.u||{},e&&Object.keys(this.u).forEach(function(n){var r=t.u[n].indexOf(e);-1!==r&&t.u[n].splice(r,1),1===t.u[n].length&&delete t.u[n]}),i.apply(this,arguments)}},shimAddTrackRemoveTrack:function(e){function t(e,t){var n=t.sdp;return Object.keys(e.s||[]).forEach(function(t){var r=e.s[t],i=e.c[r.id];n=n.replace(new RegExp(i.id,"g"),r.id)}),new RTCSessionDescription({type:t.type,sdp:n})
}var n=m.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&65<=n.version)return this.shimAddTrackRemoveTrackWithNative(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return e.s=e.s||{},t.map(function(t){return e.s[t.id]})};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var n=this;if(n.c=n.c||{},n.s=n.s||{},t.getTracks().forEach(function(e){if(n.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")}),!n.s[t.id]){var r=new e.MediaStream(t.getTracks());n.c[t.id]=r,n.s[r.id]=t,t=r}i.apply(n,[t])};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t.c=t.c||{},t.s=t.s||{},o.apply(t,[t.c[e.id]||e]),delete t.s[t.c[e.id]?t.c[e.id].id:e.id],delete t.c[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){var r=this;if("closed"===r.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(r.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError");r.c=r.c||{},r.s=r.s||{};var o=r.c[n.id];if(o)o.addTrack(t),Promise.resolve().then(function(){r.dispatchEvent(new Event("negotiationneeded"))});else{var a=new e.MediaStream([t]);r.c[n.id]=a,r.s[a.id]=n,r.addStream(a)}return r.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(n){var r=e.RTCPeerConnection.prototype[n];e.RTCPeerConnection.prototype[n]=function(){var e=this,n=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(e,[function(r){var i=t(e,r);n[0].apply(null,[i])},function(e){n[1]&&n[1].apply(null,e)},arguments[2]]):r.apply(e,arguments).then(function(n){return t(e,n)})}});var a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){var e,t,n;return arguments.length&&arguments[0].type&&(arguments[0]=(e=this,t=arguments[0],n=t.sdp,Object.keys(e.s||[]).forEach(function(t){var r=e.s[t],i=e.c[r.id];n=n.replace(new RegExp(r.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:n}))),a.apply(this,arguments)};var s=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=s.get.apply(this);return""===e.type?e:t(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t,n=this;if("closed"===n.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e.r)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e.r!==n)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");n.c=n.c||{},Object.keys(n.c).forEach(function(r){n.c[r].getTracks().find(function(t){return e.track===t})&&(t=n.c[r])}),t&&(1===t.getTracks().length?n.removeStream(n.s[t.id]):t.removeTrack(e.track),n.dispatchEvent(new Event("negotiationneeded")))}},shimPeerConnection:function(e){var t=m.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection)e.RTCPeerConnection=function(t,n){return g("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,n)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}});else{var n=e.RTCPeerConnection;e.RTCPeerConnection=function(e,t){if(e&&e.iceServers){for(var r=[],i=0;i<e.iceServers.length;i++){var o=e.iceServers[i];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(m.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,r.push(o)):r.push(e.iceServers[i])}e.iceServers=r}return new n(e,t)},e.RTCPeerConnection.prototype=n.prototype,Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return n.generateCertificate}})}var r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,n){var i=this,o=arguments;if(0<arguments.length&&"function"==typeof e)return r.apply(this,arguments);if(0===r.length&&(0===arguments.length||"function"!=typeof e))return r.apply(this,[]);var a=function(e){var t={};return e.result().forEach(function(e){var n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){n[t]=e.stat(t)}),t[n.id]=n}),t},s=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};return 2<=arguments.length?r.apply(this,[function(e){o[1](s(a(e)))},e]):new Promise(function(e,t){r.apply(i,[function(t){e(s(a(t)))},t])}).then(t,n)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,r=new Promise(function(r,i){n.apply(t,[e[0],r,i])});return e.length<2?r:r.then(function(){e[1].apply(null,[])},function(t){3<=e.length&&e[2].apply(null,[t])})}}),t.version<52&&["createOffer","createAnswer"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var t=1===arguments.length?arguments[0]:void 0;return new Promise(function(r,i){n.apply(e,[r,i,t])})}return n.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var i=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}},fixNegotiationNeeded:function(e){m.wrapPeerConnectionEvent(e,"negotiationneeded",function(e){return"stable"===e.target.signalingState?e:void 0})},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||("function"==typeof t?navigator.getDisplayMedia=function(e){return t(e).then(function(t){return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:e.video.frameRate||3}},navigator.mediaDevices.getUserMedia(e)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},b=(function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},t.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},t.getDescription=function(e){var n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){var n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter(function(e){return 0===e.indexOf(n)})},t.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:n[t[r]]=t[r+1]}return n},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:0<t[0].indexOf("/")?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,n={},r=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<r.length;i++)n[(t=r[i].trim().split("="))[0].trim()]=t[1];return n},t.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)}),t+="a=fmtp:"+n+" "+r.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},t.getMid=function(e){var n=t.matchPrefix(e,"a=mid:")[0];return n?n.substr(6):void 0},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},t.getIceParameters=function(e,n){var r=t.splitLines(e);return{usernameFragment:(r=r.concat(t.splitLines(n))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:r.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var o=r[i],a=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){var s=t.parseRtpMap(a),c=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(s.parameters=c.length?t.parseFmtp(c[0]):{},s.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),n.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(s.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach(function(e){n.headerExtensions.push(t.parseExtmap(e))}),n},t.writeRtpDescription=function(e,n){var r="";r+="m="+e+" ",r+=0<n.codecs.length?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=n.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach(function(e){r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)});var i=0;return n.codecs.forEach(function(e){e.maxptime>i&&(i=e.maxptime)}),i>0&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",n.headerExtensions&&n.headerExtensions.forEach(function(e){r+=t.writeExtmap(e)}),r},t.parseRtpEncodingParameters=function(e){var n,r=[],i=t.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),a=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=0<s.length&&s[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});0<d.length&&1<d[0].length&&d[0][0]===c&&(n=d[0][1]),i.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&n&&(t.rtx={ssrc:n}),r.push(t),o&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:n,mechanism:a?"red+ulpfec":"red"},r.push(t))}}),0===r.length&&c&&r.push({ssrc:c});var u=t.matchPrefix(e,"b=");return u.length&&(u=0===u[0].indexOf("b=TIAS:")?parseInt(u[0].substr(7),10):0===u[0].indexOf("b=AS:")?1e3*parseInt(u[0].substr(5),10)*.95-16e3:void 0,r.forEach(function(e){e.maxBitrate=u})),r},t.parseRtcpParameters=function(e){var n={},r=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);var i=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=0<i.length,n.compound=0===i.length;var o=t.matchPrefix(e,"a=rtcp-mux");return n.mux=0<o.length,n},t.parseMsid=function(e){var n,r=t.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(n=r[0].substr(7).split(" "))[0],track:n[1]};var i=t.matchPrefix(e,"a=ssrc:").map(function(e){return t.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return 0<i.length?{stream:(n=i[0].value.split(" "))[0],track:n[1]}:void 0},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,n){var r=void 0!==n?n:2;return"v=0\r\no=thisisadapterortc "+(e||t.generateSessionId())+" "+r+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,n,r,i){var o=t.writeRtpDescription(e.kind,n);if(o+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",o+=e.direction?"a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var a="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+a,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),o},t.getDirection=function(e,n){for(var r=t.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var n=t.splitLines(e)[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){var n=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var n=t.splitLines(e),r=0;r<n.length;r++)if(n[r].length<2||"="!==n[r].charAt(1))return!1;return!0},e.exports=t}(u={exports:{}},u.exports),u.exports),S=function(e,t){function n(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function c(t,n,r,i){var o=new Event("track");o.track=n,o.receiver=r,o.transceiver={receiver:r},o.streams=i,e.setTimeout(function(){t.d("track",o)})}var d=function(n){var r,i,o,a=this,c=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){a[e]=c[e].bind(c)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this.l=null,this.v=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw s("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=(r=n.iceServers||[],i=t,o=!1,(r=JSON.parse(JSON.stringify(r))).filter(function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var n="string"==typeof t;return n&&(t=[t]),t=t.filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||o?0===e.indexOf("stun:")&&i>=14393&&-1===e.indexOf("?transport=udp"):o=!0}),delete e.url,e.urls=n?t[0]:t,!!t.length}})),this.h=[],n.iceCandidatePoolSize)for(var d=n.iceCandidatePoolSize;d>0;d--)this.h.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this.p=n,this.transceivers=[],this.m=b.generateSessionId(),this.g=0,this.w=void 0,this.y=!1};Object.defineProperty(d.prototype,"localDescription",{configurable:!0,get:function(){return this.l}}),Object.defineProperty(d.prototype,"remoteDescription",{configurable:!0,get:function(){return this.v}}),d.prototype.onicecandidate=null,d.prototype.onaddstream=null,d.prototype.ontrack=null,d.prototype.onremovestream=null,d.prototype.onsignalingstatechange=null,d.prototype.oniceconnectionstatechange=null,d.prototype.onconnectionstatechange=null,d.prototype.onicegatheringstatechange=null,d.prototype.onnegotiationneeded=null,d.prototype.ondatachannel=null,d.prototype.d=function(e,t){this.y||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},d.prototype.b=function(){var e=new Event("icegatheringstatechange");this.d("icegatheringstatechange",e)},d.prototype.getConfiguration=function(){return this.p},d.prototype.getLocalStreams=function(){return this.localStreams},d.prototype.getRemoteStreams=function(){return this.remoteStreams},d.prototype.S=function(e,t){var n=0<this.transceivers.length,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&n)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this.k();r.iceTransport=i.iceTransport,r.dtlsTransport=i.dtlsTransport}return t||this.transceivers.push(r),r},d.prototype.addTrack=function(t,n){if(this.y)throw s("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var r;if(this.transceivers.find(function(e){return e.track===t}))throw s("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(r=this.transceivers[i]);return r||(r=this.S(t.kind)),this.I(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),r.track=t,r.stream=n,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},d.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach(function(t){n.addTrack(t,e)});else{var r=e.clone();e.getTracks().forEach(function(e,t){var n=r.getTracks()[t];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),r.getTracks().forEach(function(e){n.addTrack(e,r)})}},d.prototype.removeTrack=function(t){if(this.y)throw s("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find(function(e){return e.rtpSender===t});if(!n)throw s("InvalidAccessError","Sender was not created by this connection.");var r=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(r)&&-1<this.localStreams.indexOf(r)&&this.localStreams.splice(this.localStreams.indexOf(r),1),this.I()},d.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var n=t.getSenders().find(function(t){return t.track===e});n&&t.removeTrack(n)})},d.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},d.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},d.prototype.T=function(t,n){var r=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this.h.length)return this.h.shift();var i=new e.RTCIceGatherer({iceServers:this.p.iceServers,gatherPolicy:this.p.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;i.state=n?"completed":"gathering",null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},d.prototype.O=function(t,n){var r=this,i=this.transceivers[n].iceGatherer;if(!i.onlocalcandidate){var o=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,i.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),i.onlocalcandidate=function(e){if(!(r.usingBundle&&n>0)){var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:n};var a=e.candidate,s=!a||0===Object.keys(a).length;if(s)"new"!==i.state&&"gathering"!==i.state||(i.state="completed");else{"new"===i.state&&(i.state="gathering"),a.component=1,a.ufrag=i.getLocalParameters().usernameFragment;var c=b.writeCandidate(a);o.candidate=Object.assign(o.candidate,b.parseCandidate(c)),o.candidate.candidate=c,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var d=b.getMediaSections(r.l.sdp);d[o.candidate.sdpMLineIndex]+=s?"a=end-of-candidates\r\n":"a="+o.candidate.candidate+"\r\n",r.l.sdp=b.getDescription(r.l.sdp)+d.join("");var u=r.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==r.iceGatheringState&&(r.iceGatheringState="gathering",r.b()),s||r.d("icecandidate",o),u&&(r.d("icecandidate",new Event("icecandidate")),r.iceGatheringState="complete",r.b())}},e.setTimeout(function(){o.forEach(function(e){i.onlocalcandidate(e)})},0)}},d.prototype.k=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t.j(),t.C()};var r=new e.RTCDtlsTransport(n);return r.ondtlsstatechange=function(){t.C()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t.C()},{iceTransport:n,dtlsTransport:r}},d.prototype.P=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},d.prototype.R=function(e,n,r){var o=i(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(o.encodings=e.sendEncodingParameters,o.rtcp={cname:b.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(o.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(o)),r&&e.rtpReceiver&&0<o.codecs.length&&("video"===e.kind&&e.recvEncodingParameters&&15019>t&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?o.encodings=e.recvEncodingParameters:o.encodings=[{}],o.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(o.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(o.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(o))},d.prototype.setLocalDescription=function(e){var t,n,r=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(s("TypeError",'Unsupported type "'+e.type+'"'));if(!o("setLocalDescription",e.type,r.signalingState)||r.y)return Promise.reject(s("InvalidStateError","Can not set local "+e.type+" in state "+r.signalingState));if("offer"===e.type)t=b.splitSections(e.sdp),n=t.shift(),t.forEach(function(e,t){var n=b.parseRtpParameters(e);r.transceivers[t].localCapabilities=n}),r.transceivers.forEach(function(e,t){r.O(e.mid,t)});else if("answer"===e.type){t=b.splitSections(r.v.sdp),n=t.shift();var a=0<b.matchPrefix(n,"a=ice-lite").length;t.forEach(function(e,t){var o=r.transceivers[t],s=o.iceGatherer,c=o.iceTransport,d=o.dtlsTransport,u=o.localCapabilities,p=o.remoteCapabilities;if(!(b.isRejected(e)&&0===b.matchPrefix(e,"a=bundle-only").length||o.rejected)){var l=b.getIceParameters(e,n),f=b.getDtlsParameters(e,n);a&&(f.role="server"),r.usingBundle&&0!==t||(r.O(o.mid,t),"new"===c.state&&c.start(s,l,a?"controlling":"controlled"),"new"===d.state&&d.start(f));var v=i(u,p);r.R(o,0<v.codecs.length,!1)}})}return r.l={type:e.type,sdp:e.sdp},"offer"===e.type?r.D("have-local-offer"):r.D("stable"),Promise.resolve()},d.prototype.setRemoteDescription=function(r){var i=this;if(-1===["offer","answer"].indexOf(r.type))return Promise.reject(s("TypeError",'Unsupported type "'+r.type+'"'));if(!o("setRemoteDescription",r.type,i.signalingState)||i.y)return Promise.reject(s("InvalidStateError","Can not set remote "+r.type+" in state "+i.signalingState));var d={};i.remoteStreams.forEach(function(e){d[e.id]=e});var u=[],p=b.splitSections(r.sdp),l=p.shift(),f=0<b.matchPrefix(l,"a=ice-lite").length,v=0<b.matchPrefix(l,"a=group:BUNDLE ").length;i.usingBundle=v;var m=b.matchPrefix(l,"a=ice-options:")[0];return i.canTrickleIceCandidates=!!m&&0<=m.substr(14).split(" ").indexOf("trickle"),p.forEach(function(o,s){var c=b.splitLines(o),p=b.getKind(o),m=b.isRejected(o)&&0===b.matchPrefix(o,"a=bundle-only").length,h=c[0].substr(2).split(" ")[2],g=b.getDirection(o,l),y=b.parseMsid(o),S=b.getMid(o)||b.generateIdentifier();if(m||"application"===p&&("DTLS/SCTP"===h||"UDP/DTLS/SCTP"===h))i.transceivers[s]={mid:S,kind:p,protocol:h,rejected:!0};else{var T,w,C,k,R,P,E,I,M;!m&&i.transceivers[s]&&i.transceivers[s].rejected&&(i.transceivers[s]=i.S(p,!0));var D,A,O=b.parseRtpParameters(o);m||(D=b.getIceParameters(o,l),(A=b.getDtlsParameters(o,l)).role="client"),E=b.parseRtpEncodingParameters(o);var x=b.parseRtcpParameters(o),j=0<b.matchPrefix(o,"a=end-of-candidates",l).length,L=b.matchPrefix(o,"a=candidate:").map(function(e){return b.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===r.type||"answer"===r.type)&&!m&&v&&s>0&&i.transceivers[s]&&(i.P(s),i.transceivers[s].iceGatherer=i.transceivers[0].iceGatherer,i.transceivers[s].iceTransport=i.transceivers[0].iceTransport,i.transceivers[s].dtlsTransport=i.transceivers[0].dtlsTransport,i.transceivers[s].rtpSender&&i.transceivers[s].rtpSender.setTransport(i.transceivers[0].dtlsTransport),i.transceivers[s].rtpReceiver&&i.transceivers[s].rtpReceiver.setTransport(i.transceivers[0].dtlsTransport)),"offer"!==r.type||m)"answer"!==r.type||m||(w=(T=i.transceivers[s]).iceGatherer,C=T.iceTransport,k=T.dtlsTransport,R=T.rtpReceiver,P=T.sendEncodingParameters,I=T.localCapabilities,i.transceivers[s].recvEncodingParameters=E,i.transceivers[s].remoteCapabilities=O,i.transceivers[s].rtcpParameters=x,L.length&&"new"===C.state&&(!f&&!j||v&&0!==s?L.forEach(function(e){a(T.iceTransport,e)}):C.setRemoteCandidates(L)),v&&0!==s||("new"===C.state&&C.start(w,D,"controlling"),"new"===k.state&&k.start(A)),i.R(T,"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!R||"sendrecv"!==g&&"sendonly"!==g?delete T.rtpReceiver:(M=R.track,y?(d[y.stream]||(d[y.stream]=new e.MediaStream),n(M,d[y.stream]),u.push([M,R,d[y.stream]])):(d["default"]||(d["default"]=new e.MediaStream),n(M,d["default"]),u.push([M,R,d["default"]]))));else{(T=i.transceivers[s]||i.S(p)).mid=S,T.iceGatherer||(T.iceGatherer=i.T(s,v)),L.length&&"new"===T.iceTransport.state&&(!j||v&&0!==s?L.forEach(function(e){a(T.iceTransport,e)}):T.iceTransport.setRemoteCandidates(L)),I=e.RTCRtpReceiver.getCapabilities(p),15019>t&&(I.codecs=I.codecs.filter(function(e){return"rtx"!==e.name})),P=T.sendEncodingParameters||[{ssrc:1001*(2*s+2)}];var N,V=!1;"sendrecv"===g||"sendonly"===g?(V=!T.rtpReceiver,R=T.rtpReceiver||new e.RTCRtpReceiver(T.dtlsTransport,p),V&&(M=R.track,y&&"-"===y.stream||(y?(d[y.stream]||(d[y.stream]=new e.MediaStream,Object.defineProperty(d[y.stream],"id",{get:function(){return y.stream}})),Object.defineProperty(M,"id",{get:function(){return y.track}}),N=d[y.stream]):(d["default"]||(d["default"]=new e.MediaStream),N=d["default"])),N&&(n(M,N),T.associatedRemoteMediaStreams.push(N)),u.push([M,R,N]))):T.rtpReceiver&&T.rtpReceiver.track&&(T.associatedRemoteMediaStreams.forEach(function(t){var n,r,i=t.getTracks().find(function(e){return e.id===T.rtpReceiver.track.id});i&&(n=i,(r=t).removeTrack(n),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:n})))}),T.associatedRemoteMediaStreams=[]),T.localCapabilities=I,T.remoteCapabilities=O,T.rtpReceiver=R,T.rtcpParameters=x,T.sendEncodingParameters=P,T.recvEncodingParameters=E,i.R(i.transceivers[s],!1,V)}}}),void 0===i.w&&(i.w="offer"===r.type?"active":"passive"),i.v={type:r.type,sdp:r.sdp},"offer"===r.type?i.D("have-remote-offer"):i.D("stable"),Object.keys(d).forEach(function(t){var n=d[t];if(n.getTracks().length){if(-1===i.remoteStreams.indexOf(n)){i.remoteStreams.push(n);var r=new Event("addstream");r.stream=n,e.setTimeout(function(){i.d("addstream",r)})}u.forEach(function(e){var t=e[0],r=e[1];n.id===e[2].id&&c(i,t,r,[n])})}}),u.forEach(function(e){e[2]||c(i,e[0],e[1],[])}),e.setTimeout(function(){i&&i.transceivers&&i.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&0<e.iceTransport.getRemoteCandidates().length&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},d.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this.y=!0,this.D("closed")},d.prototype.D=function(e){this.signalingState=e;
var t=new Event("signalingstatechange");this.d("signalingstatechange",t)},d.prototype.I=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t.d("negotiationneeded",e)}},0))},d.prototype.j=function(){var e,t={"new":0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++}),e="new",0<t.failed?e="failed":0<t.checking?e="checking":0<t.disconnected?e="disconnected":0<t["new"]?e="new":0<t.connected?e="connected":0<t.completed&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this.d("iceconnectionstatechange",n)}},d.prototype.C=function(){var e,t={"new":0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++}),t.connected+=t.completed,e="new",0<t.failed?e="failed":0<t.connecting?e="connecting":0<t.disconnected?e="disconnected":0<t["new"]?e="new":0<t.connected&&(e="connected"),e!==this.connectionState){this.connectionState=e;var n=new Event("connectionstatechange");this.d("connectionstatechange",n)}},d.prototype.createOffer=function(){var n=this;if(n.y)return Promise.reject(s("InvalidStateError","Can not call createOffer after close"));var i=n.transceivers.filter(function(e){return"audio"===e.kind}).length,o=n.transceivers.filter(function(e){return"video"===e.kind}).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(i=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(o=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(n.transceivers.forEach(function(e){"audio"===e.kind?--i<0&&(e.wantReceive=!1):"video"===e.kind&&--o<0&&(e.wantReceive=!1)});i>0||o>0;)i>0&&(n.S("audio"),i--),o>0&&(n.S("video"),o--);var c=b.writeSessionBoilerplate(n.m,n.g++);n.transceivers.forEach(function(r,i){var o=r.track,a=r.kind,s=r.mid||b.generateIdentifier();r.mid=s,r.iceGatherer||(r.iceGatherer=n.T(i,n.usingBundle));var c=e.RTCRtpSender.getCapabilities(a);15019>t&&(c.codecs=c.codecs.filter(function(e){return"rtx"!==e.name})),c.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),r.remoteCapabilities&&r.remoteCapabilities.codecs&&r.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),c.headerExtensions.forEach(function(e){(r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[]).forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var d=r.sendEncodingParameters||[{ssrc:1001*(2*i+1)}];o&&t>=15019&&"video"===a&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),r.wantReceive&&(r.rtpReceiver=new e.RTCRtpReceiver(r.dtlsTransport,a)),r.localCapabilities=c,r.sendEncodingParameters=d}),"max-compat"!==n.p.bundlePolicy&&(c+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),c+="a=ice-options:trickle\r\n",n.transceivers.forEach(function(e,t){c+=r(e,e.localCapabilities,"offer",e.stream,n.w),c+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===n.iceGatheringState||0!==t&&n.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,c+="a="+b.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(c+="a=end-of-candidates\r\n"))});var d=new e.RTCSessionDescription({type:"offer",sdp:c});return Promise.resolve(d)},d.prototype.createAnswer=function(){var n=this;if(n.y)return Promise.reject(s("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==n.signalingState&&"have-local-pranswer"!==n.signalingState)return Promise.reject(s("InvalidStateError","Can not call createAnswer in signalingState "+n.signalingState));var o=b.writeSessionBoilerplate(n.m,n.g++);n.usingBundle&&(o+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n");var a=b.getMediaSections(n.v.sdp).length;n.transceivers.forEach(function(e,s){if(!(s+1>a)){if(e.rejected)return"application"===e.kind?o+="DTLS/SCTP"===e.protocol?"m=application 0 DTLS/SCTP 5000\r\n":"m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?o+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(o+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(o+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var d=i(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,o+=r(e,d,"answer",e.stream,n.w),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(o+="a=rtcp-rsize\r\n")}});var c=new e.RTCSessionDescription({type:"answer",sdp:o});return Promise.resolve(c)},d.prototype.addIceCandidate=function(e){var t,n=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(r,i){if(!n.v)return i(s("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var o=e.sdpMLineIndex;if(e.sdpMid)for(var c=0;c<n.transceivers.length;c++)if(n.transceivers[c].mid===e.sdpMid){o=c;break}var d=n.transceivers[o];if(!d)return i(s("OperationError","Can not add ICE candidate"));if(d.rejected)return r();var u=0<Object.keys(e.candidate).length?b.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return r();if(u.component&&1!==u.component)return r();if((0===o||o>0&&d.iceTransport!==n.transceivers[0].iceTransport)&&!a(d.iceTransport,u))return i(s("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();0===p.indexOf("a=")&&(p=p.substr(2)),(t=b.getMediaSections(n.v.sdp))[o]+="a="+(u.type?p:"end-of-candidates")+"\r\n",n.v.sdp=b.getDescription(n.v.sdp)+t.join("")}else for(var l=0;l<n.transceivers.length&&(n.transceivers[l].rejected||(n.transceivers[l].iceTransport.addRemoteCandidate({}),(t=b.getMediaSections(n.v.sdp))[l]+="a=end-of-candidates\r\n",n.v.sdp=b.getDescription(n.v.sdp)+t.join(""),!n.usingBundle));l++);r()})},d.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var n=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?n=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(n=e.rtpReceiver)}),!n)throw s("InvalidAccessError","Invalid selector.");return n.getStats()}var r=[];return this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){e[t]&&r.push(e[t].getStats())})}),Promise.all(r).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(t){var n=e[t];if(n&&n.prototype&&n.prototype.getStats){var r=n.prototype.getStats;n.prototype.getStats=function(){return r.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(n){var r;e[n].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(r=e[n]).type]||r.type,t.set(n,e[n])}),t})}}});var u=["createOffer","createAnswer"];return u.forEach(function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),d},T={shimGetUserMedia:function(e){var t=e&&e.navigator,n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e)["catch"](function(e){return Promise.reject({name:{PermissionDeniedError:"NotAllowedError"}[(t=e).name]||t.name,message:t.message,constraint:t.constraint,toString:function(){return this.name}});var t})}},shimPeerConnection:function(e){var t=m.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var n=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){n.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this.i&&("audio"===this.track.kind?this.i=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this.i=null)),this.i}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var r=S(e,t.version);e.RTCPeerConnection=function(e){var t,n,i;return e&&e.iceServers&&(e.iceServers=(t=e.iceServers,i=!1,(t=JSON.parse(JSON.stringify(t))).filter(function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&m.deprecated("RTCIceServer.url","RTCIceServer.urls");var r="string"==typeof t;return r&&(t=[t]),t=t.filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||i?0===e.indexOf("stun:")&&n>=14393&&-1===e.indexOf("?transport=udp"):i=!0}),delete e.url,e.urls=r?t[0]:t,!!t.length}}))),new r(e)},e.RTCPeerConnection.prototype=r.prototype},shimReplaceTrack:function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}},w=m.log,C={shimGetUserMedia:function(e){var t=m.detectBrowser(e),n=e&&e.navigator,r=e&&e.MediaStreamTrack,i=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},o=function(e,r,o){var a=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var r=e[n]="object"==typeof e[n]?e[n]:{ideal:e[n]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||t.push(n),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:e[n]=r.exact,delete r.exact),void 0!==r.ideal){e.advanced=e.advanced||[];var i={};"number"==typeof r.ideal?i[n]={min:r.ideal,max:r.ideal}:i[n]=r.ideal,e.advanced.push(i),delete r.ideal,Object.keys(r).length||delete e[n]}}}),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(w("spec: "+JSON.stringify(e)),e.audio&&(e.audio=a(e.audio)),e.video&&(e.video=a(e.video)),w("ff37: "+JSON.stringify(e))),n.mozGetUserMedia(e,r,function(e){o(i(e))})};if(n.mediaDevices||(n.mediaDevices={getUserMedia:function(e){return new Promise(function(t,n){o(e,t,n)})},addEventListener:function(){},removeEventListener:function(){}}),n.mediaDevices.enumerateDevices=n.mediaDevices.enumerateDevices||function(){return new Promise(function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},t.version<41){var a=n.mediaDevices.enumerateDevices.bind(n.mediaDevices);n.mediaDevices.enumerateDevices=function(){return a().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(t.version<49){var s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(e){return s(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return t},function(e){return Promise.reject(i(e))})}}if(!(55<t.version&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){var c=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},d=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(e){return"object"==typeof e&&"object"==typeof e.audio&&(e=JSON.parse(JSON.stringify(e)),c(e.audio,"autoGainControl","mozAutoGainControl"),c(e.audio,"noiseSuppression","mozNoiseSuppression")),d(e)},r&&r.prototype.getSettings){var u=r.prototype.getSettings;r.prototype.getSettings=function(){var e=u.apply(this,arguments);return c(e,"mozAutoGainControl","autoGainControl"),c(e,"mozNoiseSuppression","noiseSuppression"),e}}if(r&&r.prototype.applyConstraints){var p=r.prototype.applyConstraints;r.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"==typeof e&&(e=JSON.parse(JSON.stringify(e)),c(e,"autoGainControl","mozAutoGainControl"),c(e,"noiseSuppression","mozNoiseSuppression")),p.apply(this,[e])}}}n.getUserMedia=function(e,r,i){return t.version<44?o(e,r,i):(m.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),void n.mediaDevices.getUserMedia(e).then(r,i))}},shimOnTrack:function(e){"object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this.e},set:function(e){this.e&&(this.removeEventListener("track",this.e),this.removeEventListener("addstream",this.t)),this.addEventListener("track",this.e=e),this.addEventListener("addstream",this.t=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.transceiver={receiver:n.receiver},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))},enumerable:!0,configurable:!0}),"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(e){"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(e){var t=m.detectBrowser(e);if("object"==typeof e&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(n,r){if(t.version<38&&n&&n.iceServers){for(var i=[],o=0;o<n.iceServers.length;o++){var a=n.iceServers[o];if(a.hasOwnProperty("urls"))for(var s=0;s<a.urls.length;s++){var c={url:a.urls[s]};0===a.urls[s].indexOf("turn")&&(c.username=a.username,c.credential=a.credential),i.push(c)}else i.push(n.iceServers[o])}n.iceServers=i}return new e.mozRTCPeerConnection(n,r)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,n,o){return i.apply(this,[e||null]).then(function(e){var i,o;if(t.version<48&&(i=e,o=new Map,Object.keys(i).forEach(function(e){o.set(e,i[e]),o[e]=i[e]}),e=o),t.version<53&&!n)try{e.forEach(function(e){e.type=r[e.type]||e.type})}catch(a){if("TypeError"!==a.name)throw a;e.forEach(function(t,n){e.set(n,Object.assign({},t,{type:r[t.type]||t.type}))})}return e}).then(n,o)}}},shimSenderGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,n=t.apply(e,[]);return n.forEach(function(t){t.r=e}),n});var n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=n.apply(this,arguments);return e.r=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this.r.getStats(this.track):Promise.resolve(new Map)}}},shimReceiverGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,n=t.apply(e,[]);return n.forEach(function(t){t.r=e}),n}),m.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver.r=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){return this.r.getStats(this.track)}}},shimRemoveStream:function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;m.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(n){n.track&&-1!==e.getTracks().indexOf(n.track)&&t.removeTrack(n)})})},shimRTCDataChannel:function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||(navigator.getDisplayMedia=function(e){if(!e||!e.video){var n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return!0===e.video?e.video={mediaSource:t}:e.video.mediaSource=t,navigator.mediaDevices.getUserMedia(e)})}},k={shimLocalStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this.M||(this.M=[]),this.M}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this.M&&this.M.forEach(function(n){n.id===e&&(t=n)}),this.x&&this.x.forEach(function(n){n.id===e&&(t=n)}),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this.M||(this.M=[]),-1===this.M.indexOf(e)&&this.M.push(e);var n=this;e.getTracks().forEach(function(r){t.call(n,r,e)})},e.RTCPeerConnection.prototype.addTrack=function(e,n){return n&&(this.M?-1===this.M.indexOf(n)&&this.M.push(n):this.M=[n]),t.call(this,e,n)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this.M||(this.M=[]);var t=this.M.indexOf(e);if(-1!==t){this.M.splice(t,1);var n=this,r=e.getTracks();this.getSenders().forEach(function(e){-1!==r.indexOf(e.track)&&n.removeTrack(e)})}})}},shimRemoteStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this.x?this.x:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this.A},set:function(e){this.A&&this.removeEventListener("addstream",this.A),this.addEventListener("addstream",this.A=e)}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this.N||this.addEventListener("track",this.N=function(t){t.streams.forEach(function(t){if(e.x||(e.x=[]),!(0<=e.x.indexOf(t))){e.x.push(t);var n=new Event("addstream");n.stream=t,e.dispatchEvent(n)}})}),t.apply(e,arguments)}}},shimCallbacksAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,n=t.createOffer,r=t.createAnswer,i=t.setLocalDescription,o=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){var r=2<=arguments.length?arguments[2]:e,i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var n=2<=arguments.length?arguments[2]:e,i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i};var s=function(e,t,n){var r=i.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r};t.setLocalDescription=s,s=function(e,t,n){var r=o.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.setRemoteDescription=s,s=function(e,t,n){var r=a.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.addIceCandidate=s}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,r){t.mediaDevices.getUserMedia(e).then(n,r)}.bind(t)))},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){for(var r=[],i=0;i<e.iceServers.length;i++){var o=e.iceServers[i];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(m.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,delete o.url,r.push(o)):r.push(e.iceServers[i])}e.iceServers=r}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},shimTrackEventTransceiver:function(e){"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var n=this;if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=n.getTransceivers().find(function(e){return e.sender.track&&"audio"===e.sender.track.kind});!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveAudio||r||n.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var i=n.getTransceivers().find(function(e){return e.sender.track&&"video"===e.sender.track.kind});!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection("sendonly"):"recvonly"===i.direction&&i.setDirection("inactive"):!0!==e.offerToReceiveVideo||i||n.addTransceiver("video")}return t.apply(n,arguments)}}},R={shimRTCIceCandidate:function(e){if(e.RTCIceCandidate&&!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var n=new t(e),r=b.parseCandidate(e.candidate),i=Object.assign(n,r);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,m.wrapPeerConnectionEvent(e,"icecandidate",function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})}},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"==typeof e&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var n=t.createObjectURL.bind(t),r=t.revokeObjectURL.bind(t),i=new Map,o=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++o;return i.set(t,e),m.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return n(e)},t.revokeObjectURL=function(e){r(e),i["delete"](e)};var a=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return a.get.apply(this)},set:function(e){return this.srcObject=i.get(e)||null,a.set.apply(this,[e])}});var s=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=i.get(arguments[1])||null),s.apply(this,arguments)}}},shimMaxMessageSize:function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=m.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this.L?null:this.L}});var n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e,r,i,o;if(this.L=null,i=arguments[0],(o=b.splitSections(i.sdp)).shift(),o.some(function(e){var t=b.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})){var a,s=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var n=parseInt(t[1],10);return n!=n?-1:n}(arguments[0]),c=(e=s,r=65536,"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r),d=function(e,n){var r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);var i=b.matchPrefix(e.sdp,"a=max-message-size:");return 0<i.length?r=parseInt(i[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(r=2147483637),r}(arguments[0],s);a=0===c&&0===d?Number.POSITIVE_INFINITY:0===c||0===d?Math.max(c,d):Math.min(c,d);var u={};Object.defineProperty(u,"maxMessageSize",{get:function(){return a}}),this.L=u}return n.apply(this,arguments)}}},shimSendThrowTypeError:function(e){function t(e,t){var n=e.send;e.send=function(){var r=arguments[0],i=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=n.apply(this,arguments);return t(e,this),e},m.wrapPeerConnectionEvent(e,"datachannel",function(e){return t(e.channel,e.target),e})}}},P=function(e,t){var n=e&&e.window,r={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var i in t)hasOwnProperty.call(t,i)&&(r[i]=t[i]);var o=m.log,a=m.detectBrowser(n),s=y,c=T,d=C,u=k,p=R,l={browserDetails:a,commonShim:p,extractVersion:m.extractVersion,disableLog:m.disableLog,disableWarnings:m.disableWarnings};switch(a.browser){case"chrome":if(!s||!s.shimPeerConnection||!r.shimChrome)return o("Chrome shim is not included in this adapter release."),l;o("adapter.js shimming chrome."),l.browserShim=s,p.shimCreateObjectURL(n),s.shimGetUserMedia(n),s.shimMediaStream(n),s.shimSourceObject(n),s.shimPeerConnection(n),s.shimOnTrack(n),s.shimAddTrackRemoveTrack(n),s.shimGetSendersWithDtmf(n),s.shimSenderReceiverGetStats(n),s.fixNegotiationNeeded(n),p.shimRTCIceCandidate(n),p.shimMaxMessageSize(n),p.shimSendThrowTypeError(n);break;case"firefox":if(!d||!d.shimPeerConnection||!r.shimFirefox)return o("Firefox shim is not included in this adapter release."),l;o("adapter.js shimming firefox."),l.browserShim=d,p.shimCreateObjectURL(n),d.shimGetUserMedia(n),d.shimSourceObject(n),d.shimPeerConnection(n),d.shimOnTrack(n),d.shimRemoveStream(n),d.shimSenderGetStats(n),d.shimReceiverGetStats(n),d.shimRTCDataChannel(n),p.shimRTCIceCandidate(n),p.shimMaxMessageSize(n),p.shimSendThrowTypeError(n);break;case"edge":if(!c||!c.shimPeerConnection||!r.shimEdge)return o("MS edge shim is not included in this adapter release."),l;o("adapter.js shimming edge."),l.browserShim=c,p.shimCreateObjectURL(n),c.shimGetUserMedia(n),c.shimPeerConnection(n),c.shimReplaceTrack(n),p.shimMaxMessageSize(n),p.shimSendThrowTypeError(n);break;case"safari":if(!u||!r.shimSafari)return o("Safari shim is not included in this adapter release."),l;o("adapter.js shimming safari."),l.browserShim=u,p.shimCreateObjectURL(n),u.shimRTCIceServerUrls(n),u.shimCreateOfferLegacy(n),u.shimCallbacksAPI(n),u.shimLocalStreamsAPI(n),u.shimRemoteStreamsAPI(n),u.shimTrackEventTransceiver(n),u.shimGetUserMedia(n),p.shimRTCIceCandidate(n),p.shimMaxMessageSize(n),p.shimSendThrowTypeError(n);break;default:o("Unsupported browser!")}return l}({window:l.window}),E=c;c.mixin=function(e){var t=e.prototype||e;t.isWildEmitter=!0,t.on=function(e,t,n){this.callbacks=this.callbacks||{};var r=3===arguments.length,i=r?t:void 0,o=r?n:t;return o.F=i,(this.callbacks[e]=this.callbacks[e]||[]).push(o),this},t.once=function(e,t,n){var r=this,i=3===arguments.length,o=i?t:void 0,a=i?n:t;return this.on(e,o,function s(){r.off(e,s),a.apply(this,arguments)}),this},t.releaseGroup=function(e){var t,n,r,i;for(t in this.callbacks=this.callbacks||{},this.callbacks)for(n=0,r=(i=this.callbacks[t]).length;r>n;n++)i[n].F===e&&(i.splice(n,1),n--,r--);return this},t.off=function(e,t){this.callbacks=this.callbacks||{};var n,r=this.callbacks[e];return r&&(1===arguments.length?delete this.callbacks[e]:(n=r.indexOf(t),r.splice(n,1),0===r.length&&delete this.callbacks[e])),this},t.emit=function(e){this.callbacks=this.callbacks||{};var t,n,r,i=[].slice.call(arguments,1),o=this.callbacks[e],a=this.getWildcardCallbacks(e);if(o)for(t=0,n=(r=o.slice()).length;n>t&&r[t];++t)r[t].apply(this,i);if(a)for(n=a.length,t=0,n=(r=a.slice()).length;n>t&&r[t];++t)r[t].apply(this,[e].concat(i));return this},t.getWildcardCallbacks=function(e){this.callbacks=this.callbacks||{};var t,n,r=[];for(t in this.callbacks)n=t.split("*"),("*"===t||2===n.length&&e.slice(0,n[0].length)===n[0])&&(r=r.concat(this.callbacks[t]));return r}},c.mixin(c);var I=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.J={video:!0,appKey:"",userId:"",token:"",localMediaConstraints:{video:{width:{ideal:320},frameRate:{ideal:12},facingMode:"user"},audio:{autoGainControl:!0,channelCount:1,echoCancellation:!0,noiseSuppression:!0,sampleRate:{ideal:8e3},sampleSize:{ideal:8},volume:.9}}},e}return e(n,t),n.prototype.set=function(e,t){this.J[e]=t,this.emit("change:"+e,e,t)},n.prototype.get=function(e){return this.J[e]},n}(E);d.sessions={},d.isExtensionEnabled=function(){if(navigator.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;
return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&t>=e||d.extension.isInstalled()}return!0};var M={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var t=window.setTimeout(function(){return error=new Error("NavigatorUserMediaError"),error.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(error)},1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){var n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){var r=new Error("NavigatorUserMediaError");r.name="You cancelled the request for permission, giving up...",n(r)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(console.log("clearing ",t.data.id),window.clearTimeout(t.data.id))})}};d.useDefaultDependencies=function(e){var t=e&&e.fetch||fetch,n=e&&e.Promise||Promise,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},extension:e&&e.extension||M,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||P,httpAPICall:function(e,r){var i={method:r.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===r.verb&&(i.headers["Content-Type"]="application/json"),void 0!==r.withCredentials&&(i.credentials=!0===r.withCredentials?"include":r.withCredentials?r.withCredentials:"omit"),void 0!==r.body&&(i.body=JSON.stringify(r.body));var o=t(e,i)["catch"](function(e){return n.reject({message:"Probably a network error, is the server down?",error:e})});if(void 0!==r.timeout){var a=new n(function(e,t){var n=setTimeout(function(){return clearTimeout(n),t({message:"Request timed out",timeout:r.timeout})},r.timeout)});o=n.race([o,a])}return o.then(function(e){return e.ok?typeof r.success==typeof d.noop?e.json().then(function(e){r.success(e)})["catch"](function(t){return n.reject({message:"Failed to parse response body",error:t,response:e})}):void 0:n.reject({message:"API call failed",response:e})})["catch"](function(e){typeof r.error==typeof d.noop&&r.error(e.message||"<< internal error >>",e)}),o}}},d.useOldDependencies=function(e){var t=e&&e.jQuery||jQuery,n=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},isArray:function(e){return t.isArray(e)},extension:e&&e.extension||M,webRTCAdapter:e&&e.adapter||P,httpAPICall:function(e,n){var r=void 0!==n.body?{contentType:"application/json",data:JSON.stringify(n.body)}:{},i=void 0!==n.withCredentials?{xhrFields:{withCredentials:n.withCredentials}}:{};return t.ajax(t.extend(r,i,{url:e,type:n.verb,cache:!1,dataType:"json",async:n.async,timeout:n.timeout,success:function(e){typeof n.success==typeof d.noop&&n.success(e)},error:function(e,t,r){typeof n.error==typeof d.noop&&n.error(t,r)}}))}}},d.noop=function(){},d.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:d.noop,!0===d.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),d.trace=d.noop,d.debug=d.noop,d.vdebug=d.noop,d.log=d.noop,d.warn=d.noop,d.error=d.noop,!0===e.debug||"all"===e.debug)d.trace=console.trace.bind(console),d.debug=console.debug.bind(console),d.vdebug=console.debug.bind(console),d.log=console.log.bind(console),d.warn=console.warn.bind(console),d.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var t in e.debug){var n=e.debug[t];switch(n){case"trace":d.trace=console.trace.bind(console);break;case"debug":d.debug=console.debug.bind(console);break;case"vdebug":d.vdebug=console.debug.bind(console);break;case"log":d.log=console.log.bind(console);break;case"warn":d.warn=console.warn.bind(console);break;case"error":d.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+n+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}d.log("Initializing library");var r=e.dependencies||d.useDefaultDependencies();d.isArray=r.isArray,d.webRTCAdapter=r.webRTCAdapter,d.httpAPICall=r.httpAPICall,d.newWebSocket=r.newWebSocket,(d.extension=r.extension).init(),d.listDevices=function(e,t){e="function"==typeof e?e:d.noop,null==t&&(t={audio:!0,video:!0}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia(t).then(function(t){navigator.mediaDevices.enumerateDevices().then(function(n){d.debug(n),e(n);try{var r=t.getTracks();for(var i in r){var o=r[i];null!=o&&o.stop()}}catch(n){}})})["catch"](function(t){d.error(t),e([])}):(d.warn("navigator.mediaDevices unavailable"),e([]))},d.attachMediaStream=function(e,t){"chrome"===d.webRTCAdapter.browserDetails.browser?43<=d.webRTCAdapter.browserDetails.version?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):d.error("Error attaching stream to element"):e.srcObject=t},d.reattachMediaStream=function(e,t){"chrome"===d.webRTCAdapter.browserDetails.browser?43<=d.webRTCAdapter.browserDetails.version?e.srcObject=t.srcObject:void 0!==e.src?e.src=t.src:d.error("Error reattaching stream to element"):e.srcObject=t.srcObject};var i=window.onbeforeunload;window.onbeforeunload=function(){for(var e in d.log("Closing window"),d.sessions)null!==d.sessions[e]&&void 0!==d.sessions[e]&&d.sessions[e].destroyOnUnload&&(d.log("Destroying session "+e),d.sessions[e].destroy({asyncRequest:!1,notifyDestroyed:!1}));i&&"function"==typeof i&&i()},d.initDone=!0,e.callback()}},d.isWebrtcSupported=function(){return void 0!==window.RTCPeerConnection&&null!==window.RTCPeerConnection&&void 0!==navigator.getUserMedia&&null!==navigator.getUserMedia},d.randomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",r=0;e>r;r++){var i=Math.floor(Math.random()*t.length);n+=t.substring(i,i+1)}return n},window.getStats=function(e,t,n){var r=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;"undefined"==typeof MediaStreamTrack&&(MediaStreamTrack={});var i={encryption:"sha-256",audio:{send:{tracks:[],codecs:[],availableBandwidth:0,streams:0},recv:{tracks:[],codecs:[],availableBandwidth:0,streams:0},bytesSent:0,bytesReceived:0},video:{send:{tracks:[],codecs:[],availableBandwidth:0,streams:0},recv:{tracks:[],codecs:[],availableBandwidth:0,streams:0},bytesSent:0,bytesReceived:0},bandwidth:{systemBandwidth:0,sentPerSecond:0,encodedPerSecond:0,helper:{audioBytesSent:0,videoBytesSent:0},speed:0},results:{},connectionType:{systemNetworkType:((navigator.connection||{}).type||"unknown").toString().toLowerCase(),systemIpAddress:"192.168.1.2",local:{candidateType:[],transport:[],ipAddress:[],networkType:[]},remote:{candidateType:[],transport:[],ipAddress:[],networkType:[]}},resolutions:{send:{width:0,height:0},recv:{width:0,height:0}},internal:{audio:{send:{},recv:{}},video:{send:{},recv:{}},candidates:{}},nomore:function(){s=!0}},o={checkIfOfferer:function(e){"googLibjingleSession"===e.type&&(i.isOfferer=e.googInitiator)}},a=this;e instanceof r&&(a=e);var s=!1;o.datachannel=function(e){"datachannel"===e.type&&(i.datachannel={state:e.state})},o.googCertificate=function(e){"googCertificate"==e.type&&(i.encryption=e.googFingerprintAlgorithm)},o.checkAudioTracks=function(e){if("audio"===e.mediaType){var t=e.id.split("_").pop();if(i.audio[t]&&-1===i.audio[t].codecs.indexOf(e.googCodecName)&&i.audio[t].codecs.push(e.googCodecName),e.bytesSent){t="send";var n=0;e.bytesSent&&(i.internal.audio[t].prevBytesSent||(i.internal.audio[t].prevBytesSent=e.bytesSent),n=e.bytesSent-i.internal.audio[t].prevBytesSent,i.internal.audio[t].prevBytesSent=e.bytesSent),i.audio[t].availableBandwidth=n}e.bytesReceived&&(t="recv",n=0,e.bytesReceived&&(i.internal.audio[t].prevBytesReceived||(i.internal.audio[t].prevBytesReceived=e.bytesReceived),n=e.bytesReceived-i.internal.audio[t].prevBytesReceived,i.internal.audio[t].prevBytesReceived=e.bytesReceived),i.audio[t].availableBandwidth=n),-1===i.audio[t].tracks.indexOf(e.googTrackId)&&i.audio[t].tracks.push(e.googTrackId)}},o.checkVideoTracks=function(e){if("video"===e.mediaType){var t=e.id.split("_").pop();i.video[t]&&-1===i.video[t].codecs.indexOf(e.googCodecName)&&i.video[t].codecs.push(e.googCodecName);var n,r,o=0;e.bytesSent&&(t="send",(!i.internal.video[t].prevBytesSent||i.internal.video[t].prevBytesSent>e.bytesSent)&&(i.internal.video[t].prevBytesSent=e.bytesSent),o=e.bytesSent-i.internal.video[t].prevBytesSent,i.internal.video[t].prevBytesSent=e.bytesSent),e.bytesReceived&&(t="recv",(!i.internal.video[t].prevBytesReceived||i.internal.video[t].prevBytesReceived>e.bytesReceived)&&(i.internal.video[t].prevBytesReceived=e.bytesReceived),o=e.bytesReceived-i.internal.video[t].prevBytesReceived,i.internal.video[t].prevBytesReceived=e.bytesReceived),i.video[t].availableBandwidth=o,e.packetsLost&&(e.packetsSent&&(t="send",i.internal.video[t].prevTransPacket||(i.internal.video[t].prevTransPacket=e.packetsSent),r=e.packetsSent-i.internal.video[t].prevTransPacket,i.internal.video[t].prevTransPacket=e.packetsSent),e.packetsReceived&&(t="recv",i.internal.video[t].prevTransPacket||(i.internal.video[t].prevTransPacket=e.packetsReceived),r=e.packetsReceived-i.internal.video[t].prevTransPacket,i.internal.video[t].prevTransPacket=e.packetsReceived),i.internal.video[t].prevLostPacket||(i.internal.video[t].prevLostPacket=e.packetsLost),n=e.packetsLost-i.internal.video[t].prevLostPacket,i.internal.video[t].prevLostPacket=e.packetsLost,i.video[t].packetsLost=n,i.video[t].packetsTransferred=r,i.video[t].packetsLostRate=0!==r?.01*Math.round(n/(r+n)*1e4):100),e.googFrameHeightReceived&&e.googFrameWidthReceived&&(i.resolutions[t].width=e.googFrameWidthReceived,i.resolutions[t].height=e.googFrameHeightReceived),e.googFrameHeightSent&&e.googFrameWidthSent&&(i.resolutions[t].width=e.googFrameWidthSent,i.resolutions[t].height=e.googFrameHeightSent),-1===i.video[t].tracks.indexOf(e.googTrackId)&&i.video[t].tracks.push(e.googTrackId)}},o.bweforvideo=function(e){"VideoBwe"===e.type&&(i.bandwidth.availableSendBandwidth=e.googAvailableSendBandwidth,i.bandwidth.googActualEncBitrate=e.googActualEncBitrate,i.bandwidth.googAvailableSendBandwidth=e.googAvailableSendBandwidth,i.bandwidth.googAvailableReceiveBandwidth=e.googAvailableReceiveBandwidth,i.bandwidth.googRetransmitBitrate=e.googRetransmitBitrate,i.bandwidth.googTargetEncBitrate=e.googTargetEncBitrate,i.bandwidth.googBucketDelay=e.googBucketDelay,i.bandwidth.googTransmitBitrate=e.googTransmitBitrate)},o.candidatePair=function(e){if(("googCandidatePair"===e.type||"candidate-pair"===e.type)&&("true"==e.googActiveConnection&&(Object.keys(i.internal.candidates).forEach(function(t){var n=i.internal.candidates[t];-1!==n.ipAddress.indexOf(e.googLocalAddress)&&(i.connectionType.local.candidateType=n.candidateType,i.connectionType.local.ipAddress=n.ipAddress,i.connectionType.local.networkType=n.networkType,i.connectionType.local.transport=n.transport),-1!==n.ipAddress.indexOf(e.googRemoteAddress)&&(i.connectionType.remote.candidateType=n.candidateType,i.connectionType.remote.ipAddress=n.ipAddress,i.connectionType.remote.networkType=n.networkType,i.connectionType.remote.transport=n.transport)}),i.connectionType.transport=e.googTransportType,(t=i.internal.candidates[e.localCandidateId])&&t.ipAddress&&(i.connectionType.systemIpAddress=t.ipAddress),(n=i.internal.candidates[e.remoteCandidateId])&&n.ipAddress&&(i.connectionType.systemIpAddress=n.ipAddress)),"candidate-pair"===e.type&&!0===e.selected&&!0===e.nominated&&"succeeded"===e.state))var t=i.internal.candidates[e.remoteCandidateId],n=i.internal.candidates[e.remoteCandidateId]};var c={},d={},u={},p={};o.localcandidate=function(e){"localcandidate"!==e.type&&"local-candidate"!==e.type||e.id&&(c[e.id]||(c[e.id]=[]),d[e.id]||(d[e.id]=[]),u[e.id]||(u[e.id]=[]),p[e.id]||(p[e.id]=[]),e.candidateType&&-1===c[e.id].indexOf(e.candidateType)&&c[e.id].push(e.candidateType),e.transport&&-1===d[e.id].indexOf(e.transport)&&d[e.id].push(e.transport),e.ipAddress&&-1===u[e.id].indexOf(e.ipAddress+":"+e.portNumber)&&u[e.id].push(e.ipAddress+":"+e.portNumber),e.networkType&&-1===p[e.id].indexOf(e.networkType)&&p[e.id].push(e.networkType),i.internal.candidates[e.id]={candidateType:c[e.id],ipAddress:u[e.id],portNumber:e.portNumber,networkType:p[e.id],priority:e.priority,transport:d[e.id],timestamp:e.timestamp,id:e.id,type:e.type},i.connectionType.local.candidateType=c[e.id],i.connectionType.local.ipAddress=u[e.id],i.connectionType.local.networkType=p[e.id],i.connectionType.local.transport=d[e.id])};var l={},f={},v={},m={};o.remotecandidate=function(e){"remotecandidate"!==e.type&&"remote-candidate"!==e.type||e.id&&(l[e.id]||(l[e.id]=[]),f[e.id]||(f[e.id]=[]),v[e.id]||(v[e.id]=[]),m[e.id]||(m[e.id]=[]),e.candidateType&&-1===l[e.id].indexOf(e.candidateType)&&l[e.id].push(e.candidateType),e.transport&&-1===f[e.id].indexOf(e.transport)&&f[e.id].push(e.transport),e.ipAddress&&-1===v[e.id].indexOf(e.ipAddress+":"+e.portNumber)&&v[e.id].push(e.ipAddress+":"+e.portNumber),e.networkType&&-1===m[e.id].indexOf(e.networkType)&&m[e.id].push(e.networkType),i.internal.candidates[e.id]={candidateType:l[e.id],ipAddress:v[e.id],portNumber:e.portNumber,networkType:m[e.id],priority:e.priority,transport:f[e.id],timestamp:e.timestamp,id:e.id,type:e.type},i.connectionType.remote.candidateType=l[e.id],i.connectionType.remote.ipAddress=v[e.id],i.connectionType.remote.networkType=m[e.id],i.connectionType.remote.transport=f[e.id])},o.dataSentReceived=function(e){"video"!==e.mediaType&&"audio"!==e.mediaType||(e.bytesSent&&(i[e.mediaType].bytesSent=parseInt(e.bytesSent)),e.bytesReceived&&(i[e.mediaType].bytesReceived=parseInt(e.bytesReceived)))};var h={audio:{send:[],recv:[]},video:{send:[],recv:[]}};o.ssrc=function(e){if(e.googCodecName&&("video"===e.mediaType||"audio"===e.mediaType)&&"ssrc"===e.type){var t=e.id.split("_").pop();-1===h[e.mediaType][t].indexOf(e.ssrc)&&h[e.mediaType][t].push(e.ssrc),i[e.mediaType][t].streams=h[e.mediaType][t].length}},function g(){var e;e=function(e){if(e&&"function"==typeof e.forEach){e.forEach(function(e){Object.keys(o).forEach(function(t){"function"==typeof o[t]&&o[t](e)}),"local-candidate"!==e.type&&"remote-candidate"!==e.type&&e.type});try{-1!==a.iceConnectionState.search(/failed/gi)&&(s=!0)}catch(e){s=!0}!0===s&&(i.datachannel&&(i.datachannel.state="close"),i.ended=!0),i.results=e,i.audio&&i.video&&(i.bandwidth.speed=i.audio.bytesSent-i.bandwidth.helper.audioBytesSent+(i.video.bytesSent-i.bandwidth.helper.videoBytesSent),i.bandwidth.helper.audioBytesSent=i.audio.bytesSent,i.bandwidth.helper.videoBytesSent=i.video.bytesSent),t(i),s||void 0!==typeof n&&n&&setTimeout(g,n||1e3)}else!s&&void 0!==typeof n&&n&&setTimeout(g,n||1e3)},void 0!==window.InstallTrigger?a.getStats(null).then(function(t){var n=[];t.forEach(function(e){n.push(e)}),e(n)})["catch"](e):a.getStats(function(t){var n=[];t.result().forEach(function(e){var t={};e.names().forEach(function(n){t[n]=e.stat(n)}),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,n.push(t)}),e(n)})}()};var D=function(t){function n(e){var n=t.call(this)||this;return n.r=null,n.U=null,n.G={speed:0,packetsLost:0,packetsTransferred:0,packetsLostRate:0,bytesTransferred:0},n.V={speed:0,packetsLost:0,packetsTransferred:0,packetsLostRate:0,bytesTransferred:0},n.q=!1,e&&n.setPC(e),n}return e(n,t),n.prototype.setPC=function(e){var t=this;this.r!==e&&(window.getStats(e,function(e){return t.W(e)},1e3),this.r=e),this.q=!1},n.prototype.getStats=function(){return{send:this.G,recv:this.V}},n.prototype.destroy=function(){this.q=!0,this.U&&this.U.nomore()},n.prototype.W=function(e){if(this.U&&this.U!==e&&this.U.nomore(),this.q)e.nomore();else{this.U=e;var t=this.G;t.speed=Math.round(10*(parseFloat(String(e.video.send.availableBandwidth))+parseFloat(String(e.audio.send.availableBandwidth))))/10,t.packetsLost=parseInt(String(e.video.send.packetsLost))||0,t.packetsTransferred=parseInt(String(e.video.send.packetsTransferred))||0,t.packetsLostRate=parseInt(String(e.video.send.packetsLostRate))||0,t.bytesTransferred=parseInt(String(e.audio.bytesSent))+parseInt(String(e.video.bytesSent));var n=this.V;n.speed=Math.round(10*(parseFloat(String(e.video.recv.availableBandwidth))+parseFloat(String(e.audio.recv.availableBandwidth))))/10,n.packetsLost=parseInt(String(e.video.recv.packetsLost))||0,n.packetsTransferred=parseInt(String(e.video.recv.packetsTransferred))||0,n.packetsLostRate=parseInt(String(e.video.recv.packetsLostRate))||0,n.bytesTransferred=parseInt(String(e.audio.bytesReceived))+parseInt(String(e.video.bytesReceived)),this.emit("stats",{send:t,recv:n})}},n}(E),A=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.B=null,e._=new D,e.z="unknown",e.K=null,e}return e(n,t),n.prototype.init=function(e){var t=this;e.attach({plugin:"janus.plugin.videoroom",success:function(e){t.B=e,t.emit("init")},error:function(e){t.K=e,t.emit("error",e)},consentDialog:function(e){t.emit("consentDialog",e)},onmessage:function(e,n){t.emit("message",e,n)},onlocalstream:function(e){t.emit("localStream",e),t.z="send",t._.setPC(t.B.webrtcStuff.pc)},onremotestream:function(e){t.emit("remoteStream",e),t.z="recv",t._.setPC(t.B.webrtcStuff.pc)},ondataopen:function(){t.emit("dataOpen")},ondata:function(e){t.emit("dataReceive",e)},webrtcState:function(e){t.emit("webrtcState",e)},iceState:function(e){t.emit("iceState",e)},mediaState:function(e){t.emit("mediaState",e)},slowLink:function(e){t.emit("slowLink",e)},oncleanup:function(){t.emit("cleanup")},detached:function(){t.emit("detached")}}),this._.on("stats",function(e){t.emit("stats-update","send"===t.z?e.send:e.recv)})},n.prototype.doWhenInited=function(){var e=this;return new Promise(function(t,n){e.B?t():e.K?n(e.K):(e.once("init",function(){return t()}),e.once("error",function(e){return n(e)}))})},n.prototype.send=function(e){var t=this;this.doWhenInited().then(function(){return t.B.send(e)})},n.prototype.createOffer=function(e){var t=this;return this.doWhenInited().then(function(){return new Promise(function(n,r){t.B.createOffer({media:{audioRecv:!1,videoRecv:!1,audioSend:!0,videoSend:!0},stream:e,success:function(e){n(e)},error:function(e){var t=new Error;t.name=e,r(t)}})})})},n.prototype.createAnswer=function(e,t){var n=this;return this.doWhenInited().then(function(){return new Promise(function(r,i){n.B.createAnswer({media:e,success:function(e){r(e)},error:function(e){i(e)},jsep:t})})})},n.prototype.handleRemoteJsep=function(e){var t=this;this.doWhenInited().then(function(){return t.B.handleRemoteJsep({jsep:e})})},n.prototype.hangup=function(){this.B&&(this.B.hangup(),this._.destroy())},n.prototype.isAudioMuted=function(){return!!this.B&&this.B.isAudioMuted()},n.prototype.isVideoMuted=function(){return!!this.B&&this.B.isVideoMuted()},n.prototype.muteAudio=function(){var e=this;this.doWhenInited().then(function(){return e.B.muteAudio()})},n.prototype.unmuteAudio=function(){var e=this;this.doWhenInited().then(function(){return e.B.unmuteAudio()})},n.prototype.muteVideo=function(){var e=this;this.doWhenInited().then(function(){return e.B.muteVideo()})},n.prototype.unmuteVideo=function(){var e=this;this.doWhenInited().then(function(){return e.B.unmuteVideo()})},n.prototype.getStats=function(){var e=this._.getStats();return"send"===this.z?e.send:e.recv},n.prototype.detach=function(){this.B&&this.B.detach(),this._.destroy()},n}(E),O="error",x=function(t){function n(e){var n=t.call(this)||this;return n.H=e,n.Y=null,n.Q="disconnected",n.X=null,n.$=null,n.Z=[],n.nn=[],n.en=null,n}return e(n,t),n.prototype.init=function(){var e=this;return this.tn("connecting"),new Promise(function(t){d.init({debug:e.H.get("debug"),callback:function(){t()}})}).then(function(){return new Promise(function(t,n){e.Y=new d({server:"wss://ymrtc-dev2.youme.im/janus/",success:function(){t()},error:function(t){e.Y=null,e.en=null;var r=new Error;r.name=t,e.tn(O),n(r)},destroyed:function(){e.Y=null,e.en=null,e.tn("ended")}})})}).then(function(){return new Promise(function(t,n){e.Y.attach({plugin:"janus.plugin.videoroom",success:function(n){e.en=n,e.emit("init"),e.tn("connected"),t()},error:function(t){e.Y&&e.Y.destroy(),e.en=null;var r=new Error;r.name=t,e.tn(O),n(r)},consentDialog:function(t){e.emit("consentDialog",t)},onmessage:function(t,n){e.emit("message",t,n)},onlocalstream:function(t){e.emit("localStream",t)},onremotestream:function(t){e.emit("remoteStream",t)},ondataopen:function(){e.emit("dataOpen")},ondata:function(t){e.emit("dataReceive",t)},webrtcState:function(t){e.emit("webrtcState",t)},iceState:function(t){e.emit("iceState",t)},mediaState:function(t){e.emit("mediaState",t)},slowLink:function(t){e.emit("slowLink",t)},oncleanup:function(){e.emit("cleanup")},detached:function(){e.emit("detached")}})})})},n.prototype.destroy=function(){this.en&&this.en.detach(),this.Y&&this.Y.destroy(),this.emit("destroy")},n.prototype.doWhenInited=function(){var e=this;return new Promise(function(t){e.Y&&e.en?t():e.once("init",function(){return t()})})},n.prototype.createSubHandle=function(){var e=this,t=new A;return this.doWhenInited().then(function(){t.init(e.Y)}),t},n.prototype.getServer=function(){return this.Y?this.Y.getServer():""},n.prototype.isConnected=function(){return!!this.Y&&this.Y.isConnected()},n.prototype.getSessionId=function(){return this.Y?this.Y.getSessionId():""},n.prototype.isAudioMuted=function(){return!!this.en&&this.en.isAudioMuted()},n.prototype.isVideoMuted=function(){return!!this.en&&this.en.isVideoMuted()},n.prototype.muteAudio=function(){var e=this;this.doWhenInited().then(function(){return e.en.muteAudio()})},n.prototype.unmuteAudio=function(){var e=this;this.doWhenInited().then(function(){return e.en.unmuteAudio()})},n.prototype.muteVideo=function(){var e=this;this.doWhenInited().then(function(){return e.en.muteVideo()})},n.prototype.unmuteVideo=function(){var e=this;this.doWhenInited().then(function(){return e.en.unmuteVideo()})},n.prototype.send=function(e){var t=this;this.doWhenInited().then(function(){return t.en.send(e)})},n.prototype.createOffer=function(e){var t=this;void 0===e&&(e={});var n={media:{}};return e.stream?n.stream=e.stream:n.media=Object.assign({},e,{audioRecv:!1,videoRecv:!1,audioSend:!0,videoSend:this.H.get("video")||!!e.video}),this.doWhenInited().then(function(){return new Promise(function(e,r){t.en.createOffer(Object.assign({},{success:function(n){t.X=n,t.Z.forEach(function(e){e(n)}),e(n)},error:function(e){if("string"==typeof e){var t=new Error(e);t.name="OfferError",r(t)}else r(e)}},n))})})},n.prototype.handleRemoteJsep=function(e){var t=this;this.doWhenInited().then(function(){return t.en.handleRemoteJsep(e)}),this.$=e.jsep,this.nn.forEach(function(t){t(e.jsep)})},n.prototype.hangup=function(){this.en&&this.en.hangup()},n.prototype.requestLocalJsep=function(){var e=this;return this.X?Promise.resolve(this.X):new Promise(function(t){e.Z.push(t)})},n.prototype.requestRemoteJsep=function(){var e=this;return this.$?Promise.resolve(this.$):new Promise(function(t){e.nn.push(t)})},n.prototype.tn=function(e){this.Q!==e&&(this.Q=e,this.emit("status:"+e,e))},n.isWebRTCSupported=function(){return d.isWebrtcSupported()},n}(E),j=function(t){function n(e){var n=t.call(this)||this;return n.H=e,n["in"]=!1,n.rn="",n.an="",n.un="",n}return e(n,t),n.prototype.login=function(e,t,n){if(this["in"]){if(t===this.an)return Promise.resolve();this.logout()}return this.H.set("appKey",e),this.H.set("userId",t),this.H.set("token",n),this.rn=e,this.an=t,this.un=n,this.emit("logging"),this["in"]=!0,this.emit("login"),Promise.resolve()},n.prototype.logout=function(){this["in"]=!1,this.an="",this.emit("logout")},n.prototype.isLogin=function(){return this["in"]},n.prototype.doIfLogged=function(){var e=this;return new Promise(function(t,n){e["in"]?t():e.once("login",function(){return t()})})},n.prototype.getMyUserId=function(){return this.an},n.prototype.reconnect=function(){return this["in"]=!1,this.login(this.rn,this.an,this.un)},n}(E),L="stop",N="recording",V=function(t){function n(e,n){var r=t.call(this)||this;return r.H=e,r.sn=n,r.Q=L,r.cn=!1,r.fn=!1,r.dn=null,r.ln=[],r.vn=[],r.sn.on("localStream",function(e){e!==r.dn&&(r.dn=e,r.ln.forEach(function(t){t(e)}),r.ln=[],r.vn=[],r.emit("has-stream",r.dn))}),r.sn.on("message",function(e,t){null!=t&&r.sn.handleRemoteJsep({jsep:t})}),r}return e(n,t),n.prototype.start=function(e){var t=this;return this.dn?(this.tn(N),Promise.resolve(this.dn)):(this.tn("starting"),this.hn(e).then(function(e){return t.tn(N),e}))},n.prototype.stop=function(){this.dn&&(this.emit("remove-stream",this.dn),this.sn.send({message:{request:"unpublish"}}),this.sn.hangup(),this.dn=null,this.tn(L))},n.prototype.pause=function(){this.pn(!1),this.cn=!0,this.fn=!0,this.H.set("pauseVideo",!0),this.H.set("pauseAudio",!0),this.emit("pause-video"),this.emit("pause-audio")},n.prototype.pauseVideo=function(){this.mn(!1),this.cn=!0,this.H.set("pauseVideo",!0),this.emit("pause-video")},n.prototype.pauseAudio=function(){this.gn(!1),this.fn=!0,this.H.set("pauseAudio",!0),this.emit("pause-audio")},n.prototype.resume=function(){this.pn(!0),this.cn=!1,this.fn=!1,this.H.set("pauseVideo",!1),this.H.set("pauseAudio",!1),this.emit("resume-video"),this.emit("resume-audio")},n.prototype.resumeVideo=function(){this.mn(!0),this.cn=!1,this.H.set("pauseVideo",!1),this.emit("resume-video")},n.prototype.resumeAudio=function(){this.gn(!0),this.fn=!1,this.H.set("pauseAudio",!1),this.emit("resume-audio")},n.prototype.isVideoPaused=function(){return this.cn},n.prototype.isAudioPaused=function(){return this.fn},n.prototype.getStatus=function(){return this.Q},n.prototype.requestStream=function(){var e=this;return this.dn?Promise.resolve(this.dn):new Promise(function(t,n){e.ln.push(t),e.vn.push(n)})},n.prototype.getScreenSources=function(e){return n.wn()?new Promise(function(t,n){window.require("electron").desktopCapturer.getSources({types:e||["screen","window"]},function(e,r){e&&n(e),t(r)})}):Promise.resolve([])},n.prototype.hn=function(e){var t=this;if(e&&e.stream){this.dn=e.stream;for(var r=0,i=this.ln;r<i.length;r++)(0,i[r])(this.dn);return this.ln=[],this.vn=[],this.emit("has-stream",this.dn),Promise.resolve(this.dn)}return e&&e.video&&n.yn()&&("stdres-16:9"===e.video||"lowres-16:9"===e.video||"lowres"===e.video)&&(e.video="stdres"),e&&e.video&&("screen"===e.video||"window"===e.video)&&n.wn()?new Promise(function(n){e.electronScreenSourceId?n(e.electronScreenSourceId):t.getScreenSources([e.video]).then(function(e){n(e?e[0].id:"")})}).then(function(t){return navigator.mediaDevices.getUserMedia({audio:"screen"===e.audio&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxWidth:e.electronScreenShareMaxWidth||1280,maxHeight:e.electronScreenShareMaxHeight||720,maxFrameRate:e.electronScreenShareMaxFrameRate||6}}})}).then(function(t){return e.audio&&"screen"!==e.audio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(e){return t.addTrack(e.getAudioTracks()[0]),t}):t}).then(function(e){return t.dn=e,t.ln.forEach(function(t){t(e)}),t.ln=[],t.vn=[],t.emit("has-stream",t.dn),e})["catch"](function(e){throw t.vn.forEach(function(t){t(e)}),e}):this.sn.createOffer(e).then(function(){return t.dn?t.dn:t.requestStream()})["catch"](function(e){throw t.vn.forEach(function(t){t(e)}),e})},n.prototype.pn=function(e){e?(this.sn.unmuteAudio(),this.sn.unmuteVideo()):(this.sn.muteAudio(),this.sn.muteVideo())},n.prototype.mn=function(e){e?this.sn.unmuteVideo():this.sn.muteVideo()},n.prototype.gn=function(e){e?this.sn.unmuteAudio():this.sn.muteAudio()},n.prototype.tn=function(e){this.Q=e,this.emit("status:"+e,e)},n.wn=function(){return!!(window.process&&window.process.versions&&window.process.versions.electron)},n.yn=function(){return!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)},n}(E),U=function(t){function n(e,n,r,i,o,a){var s=t.call(this)||this;return s.H=a,s.bn=!1,s.Sn="new",s.dn=null,s.Q="new",s.an=n,s.kn=r,s.tn("negotiating"),s.In=o.createSubHandle(),s.In.send({message:{request:"join",room:e,ptype:"subscriber",feed:n,private_id:i,appkey:s.H.get("appKey")}}),s.In.on("message",function(t,n){null!=n&&s.In.createAnswer({audioRecv:!0,videoRecv:!0,audioSend:!1,videoSend:!1},n).then(function(t){s.In.send({message:{request:"start",room:e},jsep:t}),s.tn("negotiated")})}),s.In.on("remoteStream",function(e){s.bn&&s.In.muteAudio(),s.dn=e,s.emit("update-stream",e)}),s.In.on("iceState",function(e){s.Sn=e,s.emit("ice-status:"+e,e)}),s.In.on("stats-update",function(e){s.emit("media-stats-update",e)}),s}return e(n,t),n.prototype.getId=function(){return this.an},n.prototype.getName=function(){return this.kn},n.prototype.getIceConnectionState=function(){return this.Sn},n.prototype.requestStream=function(){var e=this;return this.dn?Promise.resolve(this.dn):new Promise(function(t,n){e.once("update-stream",function(e){return t(e)})})},n.prototype.getMute=function(){return this.bn},n.prototype.setMute=function(e){this.bn=e,this.dn&&(e?this.In.muteAudio():this.In.unmuteAudio())},n.prototype.getMediaStats=function(){return this.In.getStats()},n.prototype.destroy=function(){this.In.detach(),this.emit("destroy")},n.prototype.tn=function(e){this.Q!==e&&(this.Q=e,this.emit("signaling-status:"+e,e))},n}(E),F=function(t){function n(e,n,r,i,o){var a=t.call(this)||this;return a.Tn=e,a.H=n,a.En=r,a.On=i,a.sn=o,a.jn=0,a.Cn="",a.Q="out",a.Pn=!1,a.Rn={},a.In=a.sn.createSubHandle(),a.joinIn(),a.In.on("message",function(e,t){var n=!1,r=e.videoroom;if(null!=t&&a.In.handleRemoteJsep(t),r){if("joined"===r&&(a.Cn=e.private_id,a.H.set("myId",e.id),a.tn("in"),a.emit("joined"),(i=e.publishers)&&i.forEach(function(e){var t=e.id,n=e.display||""+t,r=new U(a.jn,t,n,a.Cn,a.sn,a.H);a.Rn[t]=r,a.On.registerUser(r),a.emit("member-join",t)}),n=!0),"event"===r){var i;(i=e.publishers)&&i.forEach(function(e){var t=e.id;if(!a.Rn[t]){var n=e.display||""+t,r=new U(a.jn,t,n,a.Cn,a.sn,a.H);a.Rn[t]=r,a.On.registerUser(r),a.emit("member-join",t)}});var o=e.leaving;"ok"===o&&(a.getMemberIdList().length?(a.In.detach(),a.In.off("message")):a.In.send({message:{request:"destroy",room:a.jn,appkey:a.H.get("appKey")},success:function(){a.In.detach(),a.In.off("message")}}),a.clear(),n=!0,a.tn("out")),o&&a.Rn[o]&&(a.emit("member-leave",o),a.Rn[o].destroy(),delete a.Rn[o],n=!0);var s=e.unpublished;s&&a.Rn[s]&&(a.emit("member-leave",s),a.Rn[s].destroy(),delete a.Rn[s],n=!0)}n&&a.emit("update",a.getMemberNameList())}}),a.In.on("stats-update",function(e){a.emit("media-stats-update",e)}),a}return e(n,t),n.prototype.getName=function(){return this.Tn},n.prototype.joinIn=function(){var e=this;this.In.send({message:{request:"list",appkey:this.H.get("appKey")},success:function(t){for(var n=!1,r=/[1-9][0-9]{0,19}/.test(e.Tn)&&parseInt(e.Tn)<0x10000000000000000,i=0,o=t.list;i<o.length;i++){var a=o[i];e.Tn===a.description&&(n=!0,e.jn=a.room)}if(n)e.In.send({message:{request:"join",room:e.jn,ptype:"publisher",display:e.H.get("userId"),appkey:e.H.get("appKey"),apptoken:e.H.get("token")},error:function(t){(new Error).name=t,e.emit("join-error",t)}});else{var s=r?parseInt(e.Tn):void 0;e.In.send({message:{request:"create",room:s,description:e.Tn,publishers:20,is_private:!1,videocodec:"h264",fir_freq:2,appkey:e.H.get("appKey"),apptoken:e.H.get("token"),display:e.H.get("userId"),admin_key:"supersecret"},success:function(t){var n=t.room?t.room:s;e.jn=n,e.In.send({message:{request:"join",room:n,ptype:"publisher",display:e.H.get("userId"),appkey:e.H.get("appKey"),apptoken:e.H.get("token")}})},error:function(t){(new Error).name=t,e.emit("join-error",t)}})}},error:function(t){(new Error).name=t,e.emit("join-error",t)}}),this.tn("joining")},n.prototype.publish=function(){var e=this;this.Pn||(this.Pn=!0,new Promise(function(t){"in"===e.Q?t():e.once("status:in",function(){return t()})}).then(function(){return e.Pn?e.En.requestStream():Promise.resolve(null)
}).then(function(t){return t?e.In.createOffer(t):null}).then(function(t){t&&e.In.send({message:{request:"configure",video:!0,audio:!0,appkey:e.H.get("appKey")},jsep:t})}))},n.prototype.unpublish=function(){this.Pn=!1,this.In.send({message:{request:"unpublish",appkey:this.H.get("appKey")}}),this.In.hangup()},n.prototype.leave=function(){this.In.send({message:{request:"leave",appkey:this.H.get("appKey")}})},n.prototype.clear=function(){var e=this;this.getMemberIdList().forEach(function(t){e.Rn[t].destroy(),delete e.Rn[t]})},n.prototype.getMembers=function(){return this.Rn},n.prototype.getMemberIdList=function(){return Object.keys(this.Rn)},n.prototype.getMemberNameList=function(){var e=this;return this.getMemberIdList().map(function(t){return e.Rn[t].getName()})},n.prototype.getStatus=function(){return this.Q},n.prototype.getMediaStats=function(){return this.In.getStats()},n.prototype.tn=function(e){this.Q!==e&&(this.Q=e,this.emit("status:"+e,e))},n}(E),B=function(t){function n(e,n,r,i){var o=t.call(this)||this;return o.H=e,o.En=n,o.On=r,o.sn=i,o.Dn={},o.En.on("has-stream",function(){o.getRoomNameList().forEach(function(e){o.Dn[e].publish()})}),o.En.on("remove-stream",function(){o.getRoomNameList().forEach(function(e){o.Dn[e].unpublish()})}),o}return e(n,t),n.prototype.joinRoom=function(e){this.Dn[e]&&this.leaveRoom();var t=new F(e,this.H,this.En,this.On,this.sn);return this.Mn(t),this.En.getStatus()===N&&t.publish(),this.Dn[e]=t,new Promise(function(e,n){"in"===t.getStatus()?e():(t.once("status:in",function(){return e()}),t.once("join-error",function(e){return n()}))})},n.prototype.leaveRoom=function(e){e?this.Dn[e]&&(this.Dn[e].leave(),delete this.Dn[e]):this.leaveAllRoom()},n.prototype.leaveAllRoom=function(){var e=this;this.getRoomNameList().forEach(function(t){e.Dn[t].leave()}),this.Dn={}},n.prototype.inRoom=function(e){return!!this.Dn[e]},n.prototype.getRoomNameList=function(){return Object.keys(this.Dn)},n.prototype.getRoomMemberIdList=function(e){return this.Dn[e]?this.Dn[e].getMemberIdList():[]},n.prototype.getRoomMemberNameList=function(e){return this.Dn[e]?this.Dn[e].getMemberNameList():[]},n.prototype.getRoomMediaStats=function(e){return this.Dn[e]?this.Dn[e].getMediaStats():null},n.prototype.Mn=function(e){var t=this;if(e){var n=e.getName();e.on("member-join",n,function(e){var r=t.On.getUser(e);if(r){var i=r.getName();t.emit("member-join:"+n+":"+i,n,i)}}),e.on("member-leave",n,function(e){var r=t.On.getUser(e);if(r){var i=r.getName();t.emit("member-leave:"+n+":"+i,n,i)}}),e.on("update",n,function(e){t.emit("update:"+n,n,e)}),e.on("status:in",n,function(){t.emit("join:"+n,n)}),e.on("status:out",n,function(){t.emit("leave:"+n,n),e.releaseGroup(n)}),e.on("media-stats-update",n,function(e){t.emit("media-stats-update:"+n,n,e)})}},n}(E),G=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.xn={},e.An={},e.Nn=!1,e}return e(n,t),n.prototype.registerUser=function(e){var t=e.getId(),n=e.getName();this.xn[t]=e,this.An[n]=e,this.Ln(e),this.Nn&&this.setMute(t,!0)},n.prototype.getUser=function(e){return this.xn[e]},n.prototype.getUserByName=function(e){return this.An[e]},n.prototype.requestUserStream=function(e){return this.An[e]?this.An[e].requestStream():Promise.reject("The user dose not exists.")},n.prototype.getMute=function(e){return!!this.An[e]&&this.An[e].getMute()},n.prototype.setMute=function(e,t){this.An[e]&&this.An[e].setMute(t),t||(this.Nn=!1)},n.prototype.setAllMute=function(e){for(var t=0,n=Object.keys(this.xn);t<n.length;t++){var r=n[t];this.setMute(r,e)}this.Nn=!0},n.prototype.getUserMediaStats=function(e){return this.An[e]?this.An[e].getMediaStats():null},n.prototype.Ln=function(e){var t=this,n=e.getName();e.on("update-stream",n,function(e){t.emit("update-stream:"+n,n,0,e)}),e.on("remove-stream",n,function(){t.emit("remove-stream:"+n,n,0)}),e.on("signaling-status:*",n,function(e,r){t.emit("signaling-status:"+n+":"+r,n,0,r)}),e.on("ice-status:*",n,function(e,r){t.emit("ice-status:"+n+":"+r,n,0,r)}),e.on("destroy",function(){e.releaseGroup(n),delete t.An[n],delete t.xn[e.getId()]}),e.on("media-stats-update",n,function(e){t.emit("media-stats-update:"+n,n,0,e)})},n}(E);return function(t){function n(e){var n=t.call(this)||this;return n.rn="",n.H=new I,n.sn=new x(n.H),n.En=new V(n.H,n.sn),n.Fn=new j(n.H),n.On=new G,n.Jn=new B(n.H,n.En,n.On,n.sn),n.Un(),n.Gn(),n.Vn(),n.qn(),n.Wn(),e&&n.init(e),n}return e(n,t),n.prototype.init=function(e){e.appKey&&(this.rn=e.appKey,e.userId&&e.token&&this.login(e.userId,e.token).then(),e.roomId&&this.joinRoom(e.roomId).then()),void 0!==e.video&&this.H.set("video",!!e.video),e.debug&&this.H.set("debug",e.debug)},n.prototype.login=function(e,t){var n=this;return this.sn.init().then(function(){return n.Fn.login(n.rn,e,t)})},n.prototype.logout=function(){return this.sn.destroy(),this.Fn.logout()},n.prototype.getMyUserId=function(){return this.Fn.getMyUserId()},n.prototype.joinRoom=function(e){var t=this;return this.Fn.doIfLogged().then(function(){return t.Jn.joinRoom(""+e)})},n.prototype.leaveRoom=function(e){return e?this.Jn.leaveRoom(""+e):this.Jn.leaveAllRoom()},n.prototype.inRoom=function(e){return this.Jn.inRoom(""+e)},n.prototype.getRoomIdList=function(){return this.Jn.getRoomNameList()},n.prototype.getRoomMemberIdList=function(e){return this.Jn.getRoomMemberIdList(""+e)},n.prototype.getRoomMediaStats=function(e){return this.Jn.getRoomMediaStats(""+e)},n.prototype.requestUserStream=function(e){return this.On.requestUserStream(""+e)},n.prototype.getMute=function(e){return this.On.getMute(""+e)},n.prototype.setMute=function(e,t){return this.On.setMute(""+e,t)},n.prototype.setAllMute=function(e){return this.On.setAllMute(e)},n.prototype.getUserMediaStats=function(e){return this.On.getUserMediaStats(""+e)},n.prototype.startRTC=function(e){return this.startLocalMedia(e)},n.prototype.startLocalMedia=function(e){return this.En.start(e)},n.prototype.pauseLocalMedia=function(){return this.En.pause()},n.prototype.pauseLocalVideo=function(){return this.En.pauseVideo()},n.prototype.pauseLocalAudio=function(){return this.En.pauseAudio()},n.prototype.pause=function(){return this.pauseLocalMedia()},n.prototype.resumeLocalMedia=function(){return this.En.resume()},n.prototype.resumeLocalVideo=function(){return this.En.resumeVideo()},n.prototype.resumeLocalAudio=function(){return this.En.resumeAudio()},n.prototype.resume=function(){return this.resumeLocalMedia()},n.prototype.isLocalVideoPaused=function(){return this.En.isVideoPaused()},n.prototype.isLocalAudioPaused=function(){return this.En.isAudioPaused()},n.prototype.stopLocalMedia=function(){return this.En.stop()},n.prototype.getLocalMediaStatus=function(){return this.En.getStatus()},n.prototype.electronRequestSourceList=function(e){return this.En.getScreenSources(e)},n.prototype.requestLocalMediaStream=function(){return this.En.requestStream()},n.prototype.Un=function(){var e=this;this.Fn.on("login",function(){return e.emit("account.logged")}),this.Fn.on("logging",function(){return e.emit("account.logging")}),this.Fn.on("logout",function(){return e.emit("account.logout")})},n.prototype.Gn=function(){var e=this;this.Jn.on("update:*",function(t,n,r){return e.emit("room.update:"+n,n,r)}),this.Jn.on("member-join:*",function(t,n,r){return e.emit("room.member-join:"+n,n,r)}),this.Jn.on("member-leave:*",function(t,n,r){return e.emit("room.member-leave:"+n,n,r)}),this.Jn.on("join:*",function(t,n){return e.emit("room.join:"+n,n)}),this.Jn.on("leave:*",function(t,n){return e.emit("room.leave:"+n,n)}),this.Jn.on("media-stats-update:*",function(t,n,r){return e.emit("room.media-stats-update:"+n,n,r)})},n.prototype.Vn=function(){var e=this;this.On.on("ice-status:*",function(t,n,r,i){return e.emit("user.ice-status"+(r>0?"-screen":"")+":"+n+":"+i,n,i)}),this.On.on("signaling-status:*",function(t,n,r,i){return e.emit("user.signaling-status"+(r>0?"-screen":"")+":"+n+":"+i,n,i)}),this.On.on("update-stream:*",function(t,n,r,i){return e.emit("user.update"+(r>0?"-screen":"")+"-stream:"+n,n,i)}),this.On.on("remove-stream:*",function(t,n,r){return e.emit("user.remove"+(r>0?"-screen":"")+"-stream:"+n,n)}),this.On.on("media-stats-update:*",function(t,n,r,i){return e.emit("user.media-stats-update"+(r>0?"-screen":"")+":"+n,n,i)}),this.On.on("error:*",function(t,n,r,i){return e.emit("user."+t,n,i)})},n.prototype.qn=function(){var e=this;this.En.on("status:*",function(t,n){return e.emit("local-media.status:"+n,n)}),this.En.on("has-stream",function(t){return e.emit("local-media.has-stream",t)}),this.En.on("remove-stream",function(){return e.emit("local-media.remove-stream")}),this.En.on("pause-video",function(){return e.emit("local-media.pause-video")}),this.En.on("pause-audio",function(){return e.emit("local-media.pause-audio")}),this.En.on("resume-video",function(){return e.emit("local-media.resume-video")}),this.En.on("resume-audio",function(){return e.emit("local-media.resume-audio")}),this.En.on("error",function(t){return e.emit("local-media.error",t)}),this.En.on("applied-constraints-video",function(t,n){return e.emit("local-media.applied-constraints-video",t,n)}),this.En.on("applied-constraints-audio",function(t,n){return e.emit("local-media.applied-constraints-audio",t,n)})},n.prototype.Wn=function(){var e=this;this.sn.on("status:*",function(t,n){return e.emit("signaling.status:"+n,n)}),this.sn.on("status:connected",function(){return e.emit("signaling.ready")})},n.support=x.isWebRTCSupported(),n}(E)});